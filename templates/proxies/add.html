{% extends "base.html" %}

{% block title %}Add Proxy - Telegram System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Add New Proxy</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>Supported formats:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>DataImpulse (auto-rotating):</strong><br>
                            <code>socks5://login__cr.us:password@gw.dataimpulse.com:824</code>
                        </li>
                        <li><strong>Standard with auth:</strong><br>
                            <code>socks5://username:password@host:port</code>
                        </li>
                        <li><strong>HTTP proxy:</strong><br>
                            <code>http://username:password@host:port</code>
                        </li>
                    </ul>
                </div>

                <form method="POST" action="{{ url_for("proxies.add") }}">
                    <div class="mb-3">
                        <label for="proxy_string" class="form-label">Proxy String *</label>
                        <input type="text" class="form-control" id="proxy_string" name="proxy_string" 
                               placeholder="socks5://login__cr.us:password@gw.dataimpulse.com:824" required>
                        <small class="form-text text-muted">Full proxy connection string</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_mobile" name="is_mobile">
                            <label class="form-check-label" for="is_mobile">
                                <strong>Mobile Proxy</strong> (with IP rotation)
                            </label>
                        </div>
                    </div>

                    <div id="mobile_settings" style="display: none;">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6>Mobile Proxy Settings</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Rotation Type</label>
                                    <select class="form-select" id="rotation_type" name="rotation_type">
                                        <option value="auto" selected>Auto-rotating (rotates on every request)</option>
                                        <option value="api">API-based (requires rotation URL)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        DataImpulse = Auto-rotating<br>
                                        Others = API-based
                                    </small>
                                </div>

                                <div id="api_rotation_settings" style="display: none;">
                                    <div class="mb-3">
                                        <label for="rotation_url" class="form-label">Rotation URL</label>
                                        <input type="url" class="form-control" id="rotation_url" name="rotation_url" 
                                               placeholder="https://api.proxy-provider.com/rotate?key=xxx">
                                    </div>

                                    <div class="mb-3">
                                        <label for="rotation_interval" class="form-label">Auto-rotation Interval</label>
                                        <select class="form-select" id="rotation_interval" name="rotation_interval">
                                            <option value="300">5 minutes</option>
                                            <option value="600">10 minutes</option>
                                            <option value="900">15 minutes</option>
                                            <option value="1200" selected>20 minutes</option>
                                            <option value="1800">30 minutes</option>
                                            <option value="3600">1 hour</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="auto_rotation_info" class="alert alert-success" style="display: none;">
                                    <i class="bi bi-check-circle"></i>
                                    <strong>Auto-rotating proxy!</strong> IP rotates on every request.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="test_on_add" name="test_on_add" checked>
                            <label class="form-check-label" for="test_on_add">Test connection after adding</label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle"></i> Add Proxy
                        </button>
                        <a href="{{ url_for("proxies.list_proxies") }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-star-fill text-warning"></i> DataImpulse</h5>
            </div>
            <div class="card-body">
                <p><strong>Auto-rotating mobile proxies</strong></p>
                <code class="d-block p-2 bg-light rounded">socks5://login__cr.us:pass@gw.dataimpulse.com:824</code>
                <ul class="mt-3">
                    <li>Automatic rotation on every request</li>
                    <li>No API needed</li>
                    <li>Best for anti-ban</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $("#is_mobile").on("change", function() {
        $(this).is(":checked") ? $("#mobile_settings").slideDown() : $("#mobile_settings").slideUp();
    });
    
    $("#rotation_type").on("change", function() {
        if ($(this).val() === "api") {
            $("#api_rotation_settings").slideDown();
            $("#auto_rotation_info").slideUp();
        } else {
            $("#api_rotation_settings").slideUp();
            $("#auto_rotation_info").slideDown();
        }
    });
    
    $("#proxy_string").on("input", function() {
        var proxy = $(this).val().toLowerCase();
        if (proxy.includes("dataimpulse.com") || proxy.includes("__cr.")) {
            $("#is_mobile").prop("checked", true);
            $("#mobile_settings").slideDown();
            $("#rotation_type").val("auto");
            $("#api_rotation_settings").slideUp();
            $("#auto_rotation_info").slideDown();
        }
    });
});
</script>
{% endblock %}
