{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Telegram System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ campaign.name }}</h1>
        {% if campaign.description %}
            <p class="text-muted">{{ campaign.description }}</p>
        {% endif %}
    </div>
    <div>
        <a href="{{ url_for('campaigns.list_campaigns') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Status and Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5>Status</h5>
                        {% if campaign.status == 'active' %}
                            <span class="badge bg-success fs-5">{{ campaign.status }}</span>
                            <div class="spinner-border spinner-border-sm text-success ms-2" role="status"></div>
                        {% elif campaign.status == 'paused' %}
                            <span class="badge bg-warning fs-5">{{ campaign.status }}</span>
                        {% elif campaign.status == 'completed' %}
                            <span class="badge bg-info fs-5">{{ campaign.status }}</span>
                        {% elif campaign.status == 'stopped' %}
                            <span class="badge bg-danger fs-5">{{ campaign.status }}</span>
                        {% else %}
                            <span class="badge bg-secondary fs-5">{{ campaign.status }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3">
                        <h5>Strategy</h5>
                        <span class="badge bg-{% if campaign.strategy == 'safe' %}success{% elif campaign.strategy == 'normal' %}primary{% else %}warning{% endif %} fs-6">
                            {{ campaign.strategy|upper }}
                        </span>
                    </div>
                    
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            {% if campaign.status == 'draft' or campaign.status == 'paused' %}
                            <form method="POST" action="{{ url_for('campaigns.start', campaign_id=campaign.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-play-fill"></i> Start
                                </button>
                            </form>
                            {% endif %}
                            
                            {% if campaign.status == 'active' %}
                            <form method="POST" action="{{ url_for('campaigns.pause', campaign_id=campaign.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-pause-fill"></i> Pause
                                </button>
                            </form>
                            {% endif %}
                            
                            {% if campaign.status != 'stopped' and campaign.status != 'completed' %}
                            <form method="POST" action="{{ url_for('campaigns.stop', campaign_id=campaign.id) }}" 
                                  onsubmit="return confirm('Stop this campaign? This cannot be undone.')" style="display: inline;">
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                            </form>
                            {% endif %}
                            
                            <button class="btn btn-info" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">{{ campaign.total_targets }}</h3>
                <small class="text-muted">Total Targets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ campaign.invited_count }}</h3>
                <small class="text-muted">Successfully Invited</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-danger">{{ campaign.failed_count }}</h3>
                <small class="text-muted">Failed</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                {% set success_rate = (campaign.invited_count / (campaign.invited_count + campaign.failed_count) * 100)|int if (campaign.invited_count + campaign.failed_count) > 0 else 0 %}
                <h3 class="text-{% if success_rate >= 80 %}success{% elif success_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ success_rate }}%
                </h3>
                <small class="text-muted">Success Rate</small>
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Progress</h5>
                {% set progress = (campaign.invited_count + campaign.failed_count) %}
                {% set percent = (progress / campaign.total_targets * 100)|int if campaign.total_targets > 0 else 0 %}
                
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-success" style="width: {{ (campaign.invited_count / campaign.total_targets * 100)|int if campaign.total_targets > 0 else 0 }}%">
                        {{ campaign.invited_count }} invited
                    </div>
                    <div class="progress-bar bg-danger" style="width: {{ (campaign.failed_count / campaign.total_targets * 100)|int if campaign.total_targets > 0 else 0 }}%">
                        {{ campaign.failed_count }} failed
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">{{ progress }} / {{ campaign.total_targets }} processed ({{ percent }}%)</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-md-8">
        <!-- Campaign Details -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Campaign Details</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Target Channel:</dt>
                    <dd class="col-sm-9">
                        {% if campaign.channel %}
                            <a href="{{ url_for('channels.detail', channel_id=campaign.channel.id) }}">
                                {{ campaign.channel.title }}
                            </a>
                            {% if campaign.channel.username %}
                                <code>@{{ campaign.channel.username }}</code>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No channel</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Created:</dt>
                    <dd class="col-sm-9">{{ campaign.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
                    
                    <dt class="col-sm-3">Started:</dt>
                    <dd class="col-sm-9">
                        {% if campaign.started_at %}
                            {{ campaign.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            <span class="text-muted">Not started</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Completed:</dt>
                    <dd class="col-sm-9">
                        {% if campaign.completed_at %}
                            {{ campaign.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            <span class="text-muted">Not completed</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Settings -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Settings</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Delay Range:</dt>
                    <dd class="col-sm-8">{{ campaign.delay_min }}-{{ campaign.delay_max }} seconds</dd>
                    
                    <dt class="col-sm-4">Invites per Hour:</dt>
                    <dd class="col-sm-8">{{ campaign.invites_per_hour_min }}-{{ campaign.invites_per_hour_max }}</dd>
                    
                    <dt class="col-sm-4">Burst Limit:</dt>
                    <dd class="col-sm-8">{{ campaign.burst_limit }} invites, then pause {{ campaign.burst_pause_minutes }} min</dd>
                    
                    <dt class="col-sm-4">Working Hours:</dt>
                    <dd class="col-sm-8">{{ campaign.working_hours_start.strftime('%H:%M') }} - {{ campaign.working_hours_end.strftime('%H:%M') }}</dd>
                    
                    <dt class="col-sm-4">Human-like Behavior:</dt>
                    <dd class="col-sm-8">
                        {% if campaign.human_like_behavior %}
                            <span class="badge bg-success">Enabled</span>
                        {% else %}
                            <span class="badge bg-secondary">Disabled</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Auto-pause on Errors:</dt>
                    <dd class="col-sm-8">
                        {% if campaign.auto_pause_on_errors %}
                            <span class="badge bg-success">Enabled</span>
                        {% else %}
                            <span class="badge bg-secondary">Disabled</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Assigned Accounts -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Assigned Accounts ({{ campaign.campaign_accounts.count() }})</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignAccountsModal">
                    <i class="bi bi-plus-circle"></i> Assign Accounts
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Invites Sent</th>
                                <th>Last Invite</th>
                                <th>Health</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ca in campaign.campaign_accounts %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('accounts.detail', account_id=ca.account.id) }}">
                                        {{ ca.account.phone }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if ca.status == 'active' else 'warning' }}">
                                        {{ ca.status }}
                                    </span>
                                </td>
                                <td>{{ ca.invites_sent }}</td>
                                <td>
                                    {% if ca.last_invite_at %}
                                        <small>{{ ca.last_invite_at.strftime('%H:%M:%S') }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 15px; width: 60px;">
                                        <div class="progress-bar bg-{{ 'success' if ca.account.health_score >= 70 else 'warning' if ca.account.health_score >= 40 else 'danger' }}" 
                                             style="width: {{ ca.account.health_score }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Target Users -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Target Users ({{ campaign.source_users.count() }})</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadTargetsModal">
                    <i class="bi bi-upload"></i> Upload CSV/XLS
                </button>
            </div>
            <div class="card-body">
                {% if campaign.source_users.count() > 0 %}
                <div class="row">
                    <div class="col-md-3"><strong>Total:</strong> {{ campaign.source_users.count() }}</div>
                    <div class="col-md-3"><strong>Pending:</strong> {{ campaign.source_users.filter_by(status="pending").count() }}</div>
                    <div class="col-md-3"><strong>Invited:</strong> {{ campaign.source_users.filter_by(status="invited").count() }}</div>
                    <div class="col-md-3"><strong>Failed:</strong> {{ campaign.source_users.filter_by(status="failed").count() }}</div>
                </div>
                {% else %}
                <p class="text-muted mb-0">No target users uploaded yet. Click "Upload CSV/XLS" to add users to invite.</p>
                <small class="text-muted">Expected CSV format: username</small>
                {% endif %}
            </div>
        </div>

        <!-- Recent Logs -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Time</th>
                                <th>Account</th>
                                <th>User</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in campaign.logs.all()[:50] %}
                            <tr>
                                <td><small>{{ log.timestamp.strftime('%H:%M:%S') }}</small></td>
                                <td><small>{{ log.account.phone if log.account else '-' }}</small></td>
                                <td><small>{{ log.target_user_id }}</small></td>
                                <td>
                                    {% if log.status == 'success' %}
                                        <span class="badge bg-success">{{ log.status }}</span>
                                    {% elif log.status == 'flood_wait' %}
                                        <span class="badge bg-warning">{{ log.status }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ log.status }}</span>
                                    {% endif %}
                                </td>
                                <td><small class="text-muted">{{ log.details[:50] if log.details else '-' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-md-4">
        <!-- Import Targets -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Import Targets</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('campaigns.import_users', campaign_id=campaign.id) }}">
                    <div class="mb-3">
                        <label for="source_channel" class="form-label">Source Channel</label>
                        <input type="text" class="form-control" id="source_channel" name="source_channel" 
                               placeholder="@channel_username" required>
                        <small class="form-text text-muted">Parse members from this channel</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Filters</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exclude_bots" id="exclude_bots" checked>
                            <label class="form-check-label" for="exclude_bots">
                                Exclude bots
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exclude_admins" id="exclude_admins" checked>
                            <label class="form-check-label" for="exclude_admins">
                                Exclude admins
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="only_with_photo" id="only_with_photo">
                            <label class="form-check-label" for="only_with_photo">
                                Only with profile photo
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-download"></i> Import Users
                    </button>
                </form>
            </div>
        </div>

        <!-- Error Statistics -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Error Breakdown</h5>
            </div>
            <div class="card-body">
                {% set error_stats = {} %}
                {% for log in campaign.logs.filter_by(status='flood_wait').all() %}
                    {% if error_stats.update({'flood_wait': error_stats.get('flood_wait', 0) + 1}) %}{% endif %}
                {% endfor %}
                {% for log in campaign.logs.filter_by(status='user_privacy').all() %}
                    {% if error_stats.update({'user_privacy': error_stats.get('user_privacy', 0) + 1}) %}{% endif %}
                {% endfor %}
                {% for log in campaign.logs.filter_by(status='peer_flood').all() %}
                    {% if error_stats.update({'peer_flood': error_stats.get('peer_flood', 0) + 1}) %}{% endif %}
                {% endfor %}
                
                {% if error_stats %}
                <ul class="list-group list-group-flush">
                    {% for error_type, count in error_stats.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ error_type|replace('_', ' ')|title }}
                        <span class="badge bg-danger rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No errors yet</p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Stats</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">Pending:</dt>
                    <dd class="col-sm-6 text-end">
                        <span class="badge bg-secondary">
                            {{ campaign.source_users.filter_by(status='pending').count() }}
                        </span>
                    </dd>
                    
                    <dt class="col-sm-6">Invited:</dt>
                    <dd class="col-sm-6 text-end">
                        <span class="badge bg-success">
                            {{ campaign.source_users.filter_by(status='invited').count() }}
                        </span>
                    </dd>
                    
                    <dt class="col-sm-6">Failed:</dt>
                    <dd class="col-sm-6 text-end">
                        <span class="badge bg-danger">
                            {{ campaign.source_users.filter_by(status='failed').count() }}
                        </span>
                    </dd>
                    
                    <dt class="col-sm-6">Avg Priority:</dt>
                    <dd class="col-sm-6 text-end">
                            {{ 0 }}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>


<!-- Upload Targets Modal -->
<div class="modal fade" id="uploadTargetsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for("campaigns.upload_targets", campaign_id=campaign.id) }}" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Target Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="file" class="form-label">CSV or Excel File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv,.xlsx,.xls" required>
                        <small class="form-text text-muted">File should contain column: username</small>
                    </div>
                    <div class="alert alert-info">
                        <strong>CSV Example:</strong><br>
                        <code>username</code><br>
                        <code>john_doe</code><br>
                        <code>jane_smith</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Accounts Modal -->
<div class="modal fade" id="assignAccountsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for("campaigns.assign_accounts", campaign_id=campaign.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Accounts to Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Accounts</label>
                        {% set assigned_ids = campaign.campaign_accounts.all()|map(attribute="account_id")|list %}
                        {% for account in accounts %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="account_ids" value="{{ account.id }}" id="acc{{ account.id }}" {% if account.id in assigned_ids %}disabled checked{% endif %}>
                            <label class="form-check-label" for="acc{{ account.id }}">
                                {{ account.phone }} <span class="badge bg-{{ "success" if account.status == "active" else "danger" }}">{{ account.status }}</span>
                                {% if account.id in assigned_ids %}<small class="text-muted">(already assigned)</small>{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Selected</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}


{% block extra_js %}
<script>
// Initialize Bootstrap modals
document.addEventListener("DOMContentLoaded", function() {
    console.log("Initializing modals...");
    
    // Test if Bootstrap is loaded
    if (typeof bootstrap === "undefined") {
        console.error("Bootstrap JS not loaded!");
    } else {
        console.log("Bootstrap loaded successfully");
    }
    
    // Initialize all modals
    var modalElements = document.querySelectorAll(".modal");
    modalElements.forEach(function(modalEl) {
        console.log("Found modal:", modalEl.id);
        new bootstrap.Modal(modalEl);
    });
});

// Auto-refresh for active campaigns
{% if campaign.status == "active" %}
setInterval(function() {
    location.reload();
}, 30000); // Refresh every 30 seconds
{% endif %}
</script>
{% endblock %}
