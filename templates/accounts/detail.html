{% extends "base.html" %}

{% block title %}Account {{ account.phone }} - Telegram System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Account: {{ account.phone }}</h1>
    <div>
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Account Status</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Status:</dt>
                    <dd class="col-sm-7">
                        {% if account.status == 'active' %}
                        <span class="badge bg-success">{{ account.status }}</span>
                        {% elif account.status == 'warming_up' %}
                        <span class="badge bg-warning">{{ account.status }}</span>
                        {% elif account.status == 'cooldown' %}
                        <span class="badge bg-info">{{ account.status }}</span>
                        {% else %}
                        <span class="badge bg-danger">{{ account.status }}</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5">Health:</dt>
                    <dd class="col-sm-7">
                        <div class="progress">
                            <div class="progress-bar {% if account.health_score >= 70 %}bg-success{% elif account.health_score >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
                                style="width: {{ account.health_score }}%">
                                {{ account.health_score }}%
                            </div>
                        </div>
                    </dd>

                    <dt class="col-sm-5">Created:</dt>
                    <dd class="col-sm-7">{{ account.created_at.strftime('%Y-%m-%d') }}</dd>

                    <dt class="col-sm-5">Last Activity:</dt>
                    <dd class="col-sm-7">
                        {% if account.last_activity %}
                        {{ account.last_activity.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        <span class="text-muted">Never</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5">Cooldown Until:</dt>
                    <dd class="col-sm-7">
                        {% if account.cooldown_until %}
                        {{ account.cooldown_until.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5">2FA Password:</dt>
                    <dd class="col-sm-7">
                        {% if account.two_fa_password %}
                        <code>{{ account.two_fa_password }}</code>
                        {% else %}
                        <span class="text-muted">Not Set</span>
                        {% endif %}
                    </dd>
                </dl>

                <div class="d-grid gap-2 mt-3">
                    <!-- 1. Verify Session Button (Initial Full Verify) -->
                    {% if account.first_verified_at %}
                    <!-- Blocked if already verified -->
                    <button type="button" class="btn btn-secondary w-100" disabled>
                        <i class="bi bi-check2-all"></i> Verified (Full Handshake)
                    </button>

                    <!-- 2. Light Verify Button (Check Status) - Only if verified -->
                    <form method="POST" action="{{ url_for('accounts.verify', account_id=account.id) }}">
                        <button type="submit" class="btn btn-outline-success w-100">
                            <i class="bi bi-lightning-charge"></i> Check Status (Light Verify)
                        </button>
                    </form>
                    {% else %}
                    <!-- Active if NOT verified yet -->
                    <form method="POST" action="{{ url_for('accounts.verify', account_id=account.id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-shield-check"></i> Verify Session
                        </button>
                    </form>
                    {% endif %}

                    <!-- 3. Self Check Button (Replaces Health Dropdown) -->
                    <button type="button" class="btn btn-outline-info w-100"
                        onclick="checkAccountHealth('self_check', {{ account.id }}, this)">
                        <i class="bi bi-heart-pulse"></i> Self Check (Safe)
                    </button>
                    <!-- "Sync from Telegram" removed per request -->

                    {% if account.two_fa_password %}
                    <form method="POST" action="{{ url_for('accounts.remove_2fa', account_id=account.id) }}"
                        onsubmit="return confirm('This will REMOVE the current 2FA password with human emulation (takes ~10s). Account will have NO password. Continue?');">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-unlock"></i> Remove 2FA Password
                        </button>
                    </form>
                    {% else %}
                    <form method="POST" action="{{ url_for('accounts.set_2fa', account_id=account.id) }}"
                        onsubmit="return confirm('This will set a new randomized 2FA password with human emulation (takes ~10s). Continue?');">
                        <button type="submit" class="btn btn-outline-dark w-100">
                            <i class="bi bi-shield-lock"></i> Set 2FA Password
                        </button>
                    </form>
                    {% endif %}

                    <a href="{{ url_for('accounts.activity_logs', account_id=account.id) }}"
                        class="btn btn-outline-info w-100">
                        <i class="bi bi-list-ul"></i> View Activity Logs
                    </a>
                </div>
            </div>
        </div>




        <!-- Telegram User Info Card - Insert after Account Status card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-telegram"></i> Telegram User Info</h5>
            </div>
            <div class="card-body">
                {% if account.telegram_id %}
                <div class="row mb-3">
                    <div class="col-md-4 text-center">
                        {% if account.photo_url and account.photo_url != "photo_available" %}
                        <img src="/{{ account.photo_url }}" class="rounded-circle mb-2" width="100" height="100"
                            style="object-fit: cover;">
                        {% else %}
                        <div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center"
                            style="width: 100px; height: 100px;">
                            <i class="bi bi-person-fill text-white" style="font-size: 3rem;"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">ID:</dt>
                            <dd class="col-sm-8"><code>{{ account.telegram_id }}</code></dd>

                            <dt class="col-sm-4">Name:</dt>
                            <dd class="col-sm-8">
                                {{ account.first_name }}
                                {% if account.last_name %}{{ account.last_name }}{% endif %}
                            </dd>

                            <dt class="col-sm-4">Username:</dt>
                            <dd class="col-sm-8">
                                {% if account.username %}
                                @{{ account.username }}
                                {% else %}
                                <span class="text-muted">No username</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-4">Bio:</dt>
                            <dd class="col-sm-8">
                                {% if account.bio %}
                                {{ account.bio }}
                                {% else %}
                                <span class="text-muted">No bio</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse"
                        data-bs-target="#editProfile">
                        <i class="bi bi-pencil"></i> Edit Profile
                    </button>

                    <button class="btn btn-sm btn-outline-secondary" onclick="syncProfile()" id="sync-btn"
                        title="Sync profile data from Telegram (human-like)">
                        <i class="bi bi-arrow-repeat"></i> Sync Profile
                    </button>
                </div>

                <div class="collapse mt-3" id="editProfile">
                    <form method="POST" action="{{ url_for('accounts.update_profile', account_id=account.id) }}"
                        enctype="multipart/form-data">
                        <div class="mb-2">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-control" value="{{ account.username or "" }}"
                                placeholder="username (without @)">
                            <small class="text-muted">Enter without @ symbol</small>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Bio</label>
                            <textarea name="bio" class="form-control" rows="3"
                                placeholder="About me">{{ account.bio or "" }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Profile Photo</label>
                            <input type="file" name="photo" class="form-control" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> Click "Verify Session" button above to load Telegram user
                    info
                </div>
                {% endif %}
            </div>
        </div>

    </div>

    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-phone"></i> Device Fingerprint Override</h5>
            </div>
            <div class="card-body">
                <!-- Hidden JSON device params for JavaScript -->
                {% if json_device_params %}
                <script type="application/json" id="json-device-params">
                    {{ json_device_params | tojson }}
                </script>
                {% endif %}

                <!-- Device Profile Dropdown -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Device Profile</label>
                    <select class="form-select form-select-lg" id="deviceProfileSelect"
                        data-account-id="{{ account.id }}">
                        <option value="original" {% if not account.device_profile and (not account.tdata_metadata or
                            account.tdata_metadata.device_source !='json' ) %}selected{% endif %}>
                            ‚úì Use Original from TData
                        </option>
                        {% if account.tdata_metadata and account.tdata_metadata.json_raw_data %}
                        <option value="json" {% if account.tdata_metadata.device_source=='json' %}selected{% endif %}>
                            üìÑ Use JSON parameters
                        </option>
                        {% endif %}
                        <optgroup label="üì± iOS Devices">
                            <option value="iphone15_ios18" {% if account.device_profile and
                                account.device_profile.device_model=='iPhone 15 Pro' %}selected{% endif %}>
                                iPhone 15 Pro (iOS 18.2) - Latest
                            </option>
                            <option value="iphone14_ios17" {% if account.device_profile and
                                account.device_profile.device_model=='iPhone 14 Pro' %}selected{% endif %}>
                                iPhone 14 Pro (iOS 17.6)
                            </option>
                            <option value="iphone13_ios17" {% if account.device_profile and
                                account.device_profile.device_model=='iPhone 13' %}selected{% endif %}>
                                iPhone 13 (iOS 17.4)
                            </option>
                            <option value="iphone12_ios16" {% if account.device_profile and
                                account.device_profile.device_model=='iPhone 12' %}selected{% endif %}>
                                iPhone 12 (iOS 16.7)
                            </option>
                            <option value="iphone11_ios16" {% if account.device_profile and
                                account.device_profile.device_model=='iPhone 11' %}selected{% endif %}>
                                iPhone 11 (iOS 16.5)
                            </option>
                        </optgroup>
                        <optgroup label="ü§ñ Android Devices">
                            <option value="samsung_s24_android14" {% if account.device_profile and
                                account.device_profile.device_model=='Samsung Galaxy S24 Ultra' %}selected{% endif %}>
                                Samsung Galaxy S24 Ultra (Android 14)
                            </option>
                            <option value="samsung_s21_android13" {% if account.device_profile and
                                account.device_profile.device_model=='Samsung Galaxy S21 Ultra' %}selected{% endif %}>
                                Samsung Galaxy S21 Ultra (Android 13)
                            </option>
                            <option value="pixel8_android14" {% if account.device_profile and
                                account.device_profile.device_model=='Google Pixel 8 Pro' %}selected{% endif %}>
                                Google Pixel 8 Pro (Android 14)
                            </option>
                            <option value="xiaomi14_android14" {% if account.device_profile and
                                account.device_profile.device_model=='Xiaomi 14 Pro' %}selected{% endif %}>
                                Xiaomi 14 Pro (Android 14)
                            </option>
                        </optgroup>
                        <optgroup label="üíª Desktop">
                            <option value="windows11_desktop" {% if account.device_profile and
                                account.device_profile.device_model=='Desktop' and 'Windows 11' in
                                (account.device_profile.system_version or '' ) %}selected{% endif %}>
                                Windows 11 Desktop
                            </option>
                            <option value="windows10_desktop" {% if account.device_profile and
                                account.device_profile.device_model=='Desktop' and 'Windows 10' in
                                (account.device_profile.system_version or '' ) %}selected{% endif %}>
                                Windows 10 Desktop
                            </option>
                            <option value="macos_sonoma" {% if account.device_profile and
                                account.device_profile.device_model=='Desktop' and 'macOS' in
                                (account.device_profile.system_version or '' ) %}selected{% endif %}>
                                macOS Sonoma
                            </option>
                        </optgroup>
                    </select>
                    <small class="form-text text-muted">Select a device preset to override the original TData
                        fingerprint</small>
                </div>

                <!-- Selected Profile Display -->
                <div class="bg-light p-3 rounded mb-3" id="selectedProfileDisplay">
                    <h6 class="mb-3"><strong>Selected Profile:</strong></h6>
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Device:</dt>
                        <dd class="col-sm-9 text-primary" id="profile-device">
                            {% if account.tdata_metadata and account.tdata_metadata.device_source == 'json' and
                            json_device_params %}
                            {{ json_device_params.device_model }}
                            {% elif account.device_profile %}
                            {{ account.device_profile.device_model }}
                            {% elif account.tdata_metadata %}
                            Original
                            {% else %}
                            N/A
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">System:</dt>
                        <dd class="col-sm-9 text-primary" id="profile-system">
                            {% if account.tdata_metadata and account.tdata_metadata.device_source == 'json' and
                            json_device_params %}
                            {{ json_device_params.system_version }}
                            {% elif account.device_profile %}
                            {{ account.device_profile.system_version }}
                            {% elif account.tdata_metadata %}
                            Original
                            {% else %}
                            N/A
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">App:</dt>
                        <dd class="col-sm-9 text-primary" id="profile-app">
                            {% if account.tdata_metadata and account.tdata_metadata.device_source == 'json' and
                            json_device_params %}
                            {{ json_device_params.app_version }}
                            {% elif account.device_profile %}
                            {{ account.device_profile.app_version }}
                            {% elif account.tdata_metadata %}
                            Original
                            {% else %}
                            N/A
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Language:</dt>
                        <dd class="col-sm-9 text-primary" id="profile-language">
                            {% if account.tdata_metadata and account.tdata_metadata.device_source == 'json' and
                            json_device_params %}
                            {{ json_device_params.lang_code }} / {{ json_device_params.system_lang_code }}
                            {% elif account.device_profile %}
                            {{ account.device_profile.lang_code }} / {{ account.device_profile.system_lang_code }}
                            {% elif account.tdata_metadata %}
                            {{ account.tdata_metadata.lang_code or 'en' }} / {{ account.tdata_metadata.system_lang_code
                            or 'en-US' }}
                            {% else %}
                            N/A
                            {% endif %}
                        </dd>
                    </dl>
                </div>

                <!-- Original Device Fingerprint -->
                {% if account.tdata_metadata %}
                <div class="border-top pt-3">
                    <h6 class="mb-3"><i class="bi bi-phone"></i> <strong>Original Device Fingerprint</strong></h6>
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Device Model:</dt>
                        <dd class="col-sm-8 text-danger">{{ account.tdata_metadata.device_model or 'Desktop' }}</dd>

                        <dt class="col-sm-4">System Version:</dt>
                        <dd class="col-sm-8 text-danger">{{ account.tdata_metadata.system_version or 'N/A' }}</dd>

                        <dt class="col-sm-4">App Version:</dt>
                        <dd class="col-sm-8 text-danger">{{ account.tdata_metadata.app_version or 'N/A' }}</dd>

                        <dt class="col-sm-4">Device Brand:</dt>
                        <dd class="col-sm-8 text-danger">{{ account.tdata_metadata.device_brand or 'N/A' }}</dd>

                        <dt class="col-sm-4">Language:</dt>
                        <dd class="col-sm-8 text-danger">{{ account.tdata_metadata.lang_code or 'en' }} / {{
                            account.tdata_metadata.system_lang_code or 'en-US' }}</dd>
                    </dl>
                </div>
                {% endif %}



                <hr class="my-3">
                <h6 class="mb-3"><i class="bi bi-laptop"></i> Active Sessions</h6>

                <div id="sessions-container">
                    <button class="btn btn-sm btn-outline-primary w-100" onclick="loadSessions()">
                        <i class="bi bi-cloud-download"></i> Load Active Sessions
                    </button>
                    <div id="sessions-loading" class="text-center mt-3 d-none">
                        <span class="spinner-border text-primary" role="status"></span>
                        <p class="small text-muted mt-2">Fetching sessions (human emulation in progress)...</p>
                    </div>
                </div>

                <div id="sessions-list" class="mt-3 d-none">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Location</th>
                                    <th>Active</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="sessions-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-sm btn-outline-danger w-100 mt-2" onclick="terminateAllSessions()">
                        <i class="bi bi-x-circle"></i> Terminate All Other Sessions
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Proxy Assignment</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('accounts.assign_proxy', account_id=account.id) }}">
                <div class="row">
                    <div class="col-md-9">
                        <select class="form-select" name="proxy_id">
                            <option value="">No proxy</option>
                            {% for proxy in proxies %}
                            <option value="{{ proxy.id }}" {% if account.proxy_id==proxy.id %}selected{% endif %}>
                                {{ proxy.flag }} {{ proxy.type }}://{{ proxy.host }}:{{ proxy.port }}
                                {% if proxy.current_ip %}({{ proxy.current_ip }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Update</button>
                    </div>
                </div>
            </form>

            {% if account.proxy %}
            <div class="mt-3 p-3 bg-light rounded">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>Current Proxy:</strong><br>
                        {% if account.proxy.country %}<span class="badge bg-info">üåç {{ account.proxy.country
                            }}</span> {% endif %}
                        Type: {{ account.proxy.type }}<br>
                        Host: {{ account.proxy.host }}:{{ account.proxy.port }}<br>
                        IP: <span id="proxy-ip">{{ account.proxy.current_ip or 'Unknown' }}</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" id="refresh-ip-btn"
                            onclick="refreshProxyIP({{ account.proxy.id }})">
                            <i class="bi bi-arrow-clockwise"></i> Refresh IP
                        </button>
                        <br>
                        Status: <span
                            class="badge bg-{{ 'success' if account.proxy.status == 'active' else 'danger' }}">
                            {{ account.proxy.status }}
                        </span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>




    <!-- WARMUP DISABLED - OLD SYSTEM
        Conversation Pairs section hidden
        Will be reimplemented in new balanced warmup system
        
        <div class="card mb-3">
            ...
        </div>
        END WARMUP DISABLED -->


    <!-- WARMUP DISABLED - OLD SYSTEM
        Recent Warmup Activity section hidden
        Will be reimplemented in new balanced warmup system
        
        {% if recent_activities %}
        <div class="card mb-3">
            ...
        </div>
        {% endif %}
        END WARMUP DISABLED -->

    <!-- NEW WARMUP SYSTEM -->
    {% include 'accounts/warmup_section.html' %}

    <!-- DISCOVERED CHANNELS -->
    {% include 'accounts/channel_candidates_section.html' %}

    <!-- SCHEDULER UI -->
    {% include 'accounts/scheduler_section.html' %}
</div>
</div>

<!-- Add Subscription Modal -->
<div class="modal fade" id="addSubscriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('accounts.add_subscription', account_id=account.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="channel_username" class="form-label">Channel Username</label>
                        <input type="text" class="form-control" id="channel_username" name="channel_username"
                            placeholder="username or @username" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Subscription</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Pair Modal -->
<div class="modal fade" id="addPairModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Conversation Pair</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('accounts.add_conversation_pair', account_id=account.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="partner_id" class="form-label">Select Partner Account</label>
                        <select class="form-select" id="partner_id" name="partner_id" required>
                            <option value="">Choose an account...</option>
                            {% for other in other_accounts %}
                            <option value="{{ other.id }}">
                                {{ other.phone }}
                                {% if other.username %}(@{{ other.username }}){% endif %}
                                [{{ other.status }}]
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Both accounts must be in 'warming_up' or 'active' status.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Pair</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='js/account_health.js') }}"></script>
<script src="{{ url_for('static', filename='js/account_detail.js') }}"></script>

{% endblock %}

{% block modals %}
<script src="{{ url_for('static', filename='js/device_profile.js') }}"></script>
{% endblock %}