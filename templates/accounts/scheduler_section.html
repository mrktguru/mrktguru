<!-- Warmup Scheduler Section -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üî• Warmup Scheduler</h5>
        <div>
            <button class="btn btn-sm btn-light" id="save-schedule-btn">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-sm btn-success" id="start-schedule-btn">
                <i class="bi bi-play-fill"></i> Start
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            <!-- Node Library Sidebar -->
            <div class="col-md-3 border-end p-3" style="background-color: #f8f9fa;">
                <h6 class="mb-3">üì¶ Available Nodes</h6>
                <p class="text-muted small">Drag nodes to calendar</p>

                <!-- Profile Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üë§ Profile</strong>
                    <div class="node-item draggable mb-2" data-node-type="bio">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-person-badge"></i> Bio
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="username">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-at"></i> Username
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="photo">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-camera"></i> Photo
                        </div>
                    </div>
                </div>

                <!-- Contact Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üìû Contacts</strong>
                    <div class="node-item draggable mb-2" data-node-type="import_contacts">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-person-plus"></i> Import
                        </div>
                    </div>
                    <!-- Search & Filter -->
                    <div class="node-item draggable mb-2" data-node-type="search_filter">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-search"></i> Search & Filter
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="send_message">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-chat"></i> Send Message
                        </div>
                    </div>
                </div>

                <!-- Channel Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üì∫ Channels</strong>
                    <div class="node-item draggable mb-2" data-node-type="subscribe">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-bookmark-plus"></i> Subscribe
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="visit">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-eye"></i> Visit
                        </div>
                    </div>
                </div>

                <!-- Other Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üí§ Other</strong>
                    <div class="node-item draggable mb-2" data-node-type="idle">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-moon"></i> Idle
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="col-md-9 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">14-Day Warmup Plan</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="clear-schedule-btn">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div id="scheduler-calendar" class="scheduler-calendar" data-account-id="{{ account.id }}"
                    data-bio="{{ account.bio | default('', true) | e }}"
                    data-username="{{ account.username | default('', true) | e }}"
                    data-first-name="{{ account.first_name | default('', true) | e }}"
                    data-last-name="{{ account.last_name | default('', true) | e }}"
                    data-photo-url="{{ account.photo_url | default('', true) | e }}">
                    <!-- Days 1-7 -->
                    <div class="row mb-2">
                        <div class="col">
                            <div class="day-cell droppable" data-day="1">
                                <div class="day-header">Day 1</div>
                                <div class="day-nodes" id="day-1-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="2">
                                <div class="day-header">Day 2</div>
                                <div class="day-nodes" id="day-2-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="3">
                                <div class="day-header">Day 3</div>
                                <div class="day-nodes" id="day-3-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="4">
                                <div class="day-header">Day 4</div>
                                <div class="day-nodes" id="day-4-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="5">
                                <div class="day-header">Day 5</div>
                                <div class="day-nodes" id="day-5-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="6">
                                <div class="day-header">Day 6</div>
                                <div class="day-nodes" id="day-6-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="7">
                                <div class="day-header">Day 7</div>
                                <div class="day-nodes" id="day-7-nodes"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Days 8-14 -->
                    <div class="row">
                        <div class="col">
                            <div class="day-cell droppable" data-day="8">
                                <div class="day-header">Day 8</div>
                                <div class="day-nodes" id="day-8-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="9">
                                <div class="day-header">Day 9</div>
                                <div class="day-nodes" id="day-9-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="10">
                                <div class="day-header">Day 10</div>
                                <div class="day-nodes" id="day-10-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="11">
                                <div class="day-header">Day 11</div>
                                <div class="day-nodes" id="day-11-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="12">
                                <div class="day-header">Day 12</div>
                                <div class="day-nodes" id="day-12-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="13">
                                <div class="day-header">Day 13</div>
                                <div class="day-nodes" id="day-13-nodes"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="day-cell droppable" data-day="14">
                                <div class="day-header">Day 14</div>
                                <div class="day-nodes" id="day-14-nodes"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .scheduler-calendar {
        min-height: 400px;
    }

    .day-cell {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        min-height: 150px;
        padding: 8px;
        background: white;
        transition: all 0.2s;
    }

    .day-cell.drag-over {
        border-color: #0d6efd;
        background-color: #e7f1ff;
    }

    .day-header {
        font-weight: bold;
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid #dee2e6;
    }

    .day-nodes {
        min-height: 100px;
    }

    .node-item.draggable {
        cursor: move;
        user-select: none;
    }

    .node-item.draggable:hover {
        opacity: 0.8;
    }

    .scheduled-node {
        background: #e7f1ff;
        border: 1px solid #0d6efd;
        border-radius: 4px;
        padding: 6px 8px;
        margin-bottom: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        position: relative;
    }

    .scheduled-node:hover {
        background: #cfe2ff;
    }

    .scheduled-node .remove-node {
        position: absolute;
        top: 2px;
        right: 2px;
        cursor: pointer;
        color: #dc3545;
        font-size: 0.75rem;
    }

    .scheduled-node .node-time {
        font-size: 0.7rem;
        color: #6c757d;
        display: block;
    }

    .node-config-modal {
        padding: 1rem;
        max-height: 80vh;
        overflow-y: auto;
    }

    /* Executing state */
    .scheduled-node.executing {
        background: #fff3cd !important;
        border-color: #ffc107 !important;
        animation: pulse 1.5s infinite;
    }

    /* Success state */
    .scheduled-node.node-success {
        background: #d1e7dd !important;
        border-color: #198754 !important;
    }

    /* Error state */
    .scheduled-node.node-error {
        background: #f8d7da !important;
        border-color: #dc3545 !important;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }
</style>

<!-- Node Configuration Modal -->
<div class="modal fade" id="nodeConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Node</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nodeConfigForm">
                    <!-- Common Fields -->
                    <div class="mb-3">
                        <label class="form-label">Execution Time</label>
                        <div class="d-flex gap-2">
                            <input type="time" class="form-control" name="execution_time">
                            <div class="form-check d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" name="is_random_time"
                                    id="isRandomTime">
                                <label class="form-check-label" for="isRandomTime">Random</label>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Fields Container -->
                    <div id="dynamicFields"></div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button type="button" class="btn btn-warning" id="runNodeNowBtn">
                        <i class="bi bi-lightning-fill"></i> Run Now
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNodeConfigBtn">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>
</div>

bio: "{{ account.bio | default('', true) }}",
username: "{{ account.username | default('', true) }}",
first_name: "{{ account.first_name | default('', true) }}",
last_name: "{{ account.last_name | default('', true) }}",
photo_url: "{{ account.photo_url | default('', true) }}"
};

let scheduleData = {
schedule_id: null,
nodes: []
};

let currentNode = null; // Track node being edited
let currentNodeDay = null;
let configModal = null;

// Initialize drag and drop
document.addEventListener('DOMContentLoaded', function () {
initDragAndDrop();
loadSchedule();

configModal = new bootstrap.Modal(document.getElementById('nodeConfigModal'));

// Modal Save Handler
document.getElementById('saveNodeConfigBtn').addEventListener('click', saveConfig);

// Run Now Handler
document.getElementById('runNodeNowBtn').addEventListener('click', runNodeNow);

// Random time toggler
document.getElementById('isRandomTime').addEventListener('change', function (e) {
document.querySelector('input[name="execution_time"]').disabled = e.target.checked;
});
});

function initDragAndDrop() {
// Make nodes draggable
const draggables = document.querySelectorAll('.node-item.draggable');

draggables.forEach(item => {
item.addEventListener('dragstart', handleDragStart);
item.addEventListener('dragend', handleDragEnd);
item.setAttribute('draggable', 'true');
});

// Make day cells droppable
const dropZones = document.querySelectorAll('.day-cell.droppable');

dropZones.forEach(zone => {
zone.addEventListener('dragover', handleDragOver);
zone.addEventListener('dragleave', handleDragLeave);
zone.addEventListener('drop', handleDrop);
});
}

let draggedNodeType = null;

function handleDragStart(e) {
draggedNodeType = this.dataset.nodeType;
this.style.opacity = '0.4';
}

function handleDragEnd(e) {
this.style.opacity = '1';
}

function handleDragOver(e) {
e.preventDefault();
this.classList.add('drag-over');
}

function handleDragLeave(e) {
this.classList.remove('drag-over');
}

function handleDrop(e) {
e.preventDefault();
this.classList.remove('drag-over');

const dayNumber = parseInt(this.dataset.day);

if (draggedNodeType) {
addNodeToDay(draggedNodeType, dayNumber);
draggedNodeType = null;
}
}

// Helper to get local time string HH:MM
function getCurrentTime() {
const now = new Date();
return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
}

function addNodeToDay(nodeType, dayNumber) {
// Create node object
const node = {
node_type: nodeType,
day_number: dayNumber,
execution_time: getCurrentTime(), // Use local time
is_random_time: false,
config: {}
};

// Add to schedule data
scheduleData.nodes.push(node);

// Render node
renderNode(node, dayNumber);

console.log('Added node:', node);

// Automatically open config
openNodeConfig(node, dayNumber);
}

function renderNode(node, dayNumber) {
const container = document.getElementById(`day-${dayNumber}-nodes`);

// Avoid duplicates in UI if re-rendering from load
// But for new nodes, we just append. To be safe, we could clear and re-render day, but simpler to just append.

// Check if node element already exists (if we pass a unique ID, but we don't have one for new nodes yet).
// For simplicity, we create a fresh element.

const nodeEl = document.createElement('div');
nodeEl.className = 'scheduled-node';
// Store reference to object for easy access
nodeEl._nodeObj = node;

updateNodeVisuals(nodeEl, node, dayNumber);

container.appendChild(nodeEl);
}

function updateNodeVisuals(el, node, dayNumber) {
el.innerHTML = `
<span class="remove-node" onclick="window.removeSchedulerNode(this, ${dayNumber}, '${node.node_type}')">√ó</span>
<strong>${getNodeLabel(node.node_type)}</strong>
<span class="node-time">${node.is_random_time ? 'üé≤ Random' : node.execution_time}</span>
${getConfigSummary(node)}
`;

el.onclick = function (e) {
// Prevent triggering if clicked on remove 'x'
if (e.target.className === 'remove-node') return;
openNodeConfig(node, dayNumber, el);
};
}

function getConfigSummary(node) {
if (!node.config) return '';
let summary = [];
if (node.config.count) summary.push(`${node.config.count}x`);
if (node.config.channels) summary.push(`${node.config.channels.split(',').length} chs`);
if (node.config.photo_path) summary.push('üì∑ set');
if (node.config.keywords || node.config.links) {
const kwCount = node.config.keywords ? node.config.keywords.split('\n').filter(l => l.trim()).length : 0;
const linkCount = node.config.links ? node.config.links.split('\n').filter(l => l.trim()).length : 0;
if (kwCount > 0) summary.push(`üîç ${kwCount} kw`);
if (linkCount > 0) summary.push(`üîó ${linkCount} links`);
}
return summary.length ? `<span class="d-block text-muted small" style="font-size:0.65rem">${summary.join(' ‚Ä¢ ')}</span>`
: '';
}

function getNodeLabel(nodeType) {
const labels = {
'bio': 'üë§ Bio',
'username': '@Username',
'photo': 'üì∑ Photo',
'import_contacts': 'üìû Import',
'search_filter': 'üîç Search & Filter',
'send_message': 'üí¨ Message',
'subscribe': 'üì∫ Subscribe',
'visit': 'üëÅÔ∏è Visit',
'idle': 'üí§ Idle'
};
return labels[nodeType] || nodeType;
}

window.removeSchedulerNode = function (el, dayNumber, nodeType) {
// Prevent event bubbling handled in onclick but safety check
if (event) event.stopPropagation();

el.parentElement.remove();

// Remove from schedule data
// We need to match the specific node object instance to be safe
// Or if simple match:
scheduleData.nodes = scheduleData.nodes.filter(n =>
n !== el.parentElement._nodeObj
);
};

function openNodeConfig(node, dayNumber, nodeEl = null) {
currentNode = node;
currentNodeDay = dayNumber;
// Keep ref to element to update visuals after save
if (!nodeEl) {
// Try to find it if not passed (e.g. from addNodeToDay)
// This is tricky. For now, rely on re-rendering whole day or user click.
// If adds new, 'renderNode' sets _nodeObj.
// We can find it via DOM.
const container = document.getElementById(`day-${dayNumber}-nodes`);
if (container && container.lastChild && container.lastChild._nodeObj === node) {
currentNode.el = container.lastChild;
}
} else {
currentNode.el = nodeEl;
}

// Fill Form
const form = document.getElementById('nodeConfigForm');
form.execution_time.value = node.execution_time;
form.is_random_time.checked = node.is_random_time;
form.execution_time.disabled = node.is_random_time;

renderDynamicFields(node.node_type, node.config);

configModal.show();
}

function renderDynamicFields(type, config) {
const container = document.getElementById('dynamicFields');
container.innerHTML = '';
config = config || {};

let html = '';

if (['send_message', 'import_contacts', 'invite'].includes(type)) {
html += `
<div class="mb-3">
    <label class="form-label">Count</label>
    <input type="number" class="form-control" name="count" value="${config.count || 10}">
</div>
<div class="row">
    <div class="col">
        <label class="form-label">Min Interval (s)</label>
        <input type="number" class="form-control" name="interval_min" value="${config.interval_min || 30}">
    </div>
    <div class="col">
        <label class="form-label">Max Interval (s)</label>
        <input type="number" class="form-control" name="interval_max" value="${config.interval_max || 120}">
    </div>
</div>
`;
}
else if (['subscribe', 'visit'].includes(type)) {
html += `
<div class="mb-3">
    <label class="form-label">Target Channels (@username or link)</label>
    <textarea class="form-control" name="channels" rows="3"
        placeholder="@channel1, https://t.me/channel2">${config.channels || ''}</textarea>
    <div class="form-text">Comma separated</div>
</div>
<div class="row">
    <div class="col">
        <label class="form-label">Count</label>
        <input type="number" class="form-control" name="count" value="${config.count || 5}">
    </div>
    <div class="col">
        <label class="form-label">Interval (s)</label>
        <input type="number" class="form-control" name="interval" value="${config.interval || 30}">
    </div>
</div>
`;
}
else if (type === 'photo') {
html += `
<div class="mb-3">
    <label class="form-label">Profile Photo</label>
    <input type="file" class="form-control" id="photoInput">
    <input type="hidden" name="photo_path" value="${config.photo_path || ''}">
    <div id="photoPreview" class="mt-2 text-muted small">
        ${config.photo_path ? 'Current: ' + config.photo_path.split('/').pop() : ''}
    </div>
</div>
`;
}
else if (type === 'bio') {
// Pre-fill Logic: Use existing DB bio if config is empty
const defaultBio = config.bio_text || accountData.bio;

html += `
<div class="mb-3">
    <label class="form-label">Bio Text</label>
    <textarea class="form-control" name="bio_text" rows="3" placeholder="About me">${defaultBio}</textarea>
</div>
`;
}
else if (type === 'search_filter') {
html += `
<div class="mb-3">
    <label class="form-label">Keywords (one per line)</label>
    <textarea class="form-control" name="keywords" rows="3"
        placeholder="Interior Design\nNews NYC\nCrypto Trading">${config.keywords || ''}</textarea>
    <small class="form-text text-muted">Generic keywords for organic search</small>
</div>
<div class="mb-3">
    <label class="form-label">Links (one per line)</label>
    <textarea class="form-control" name="links" rows="3"
        placeholder="t.me/example_channel\n@username\nhttps://t.me/another">${config.links || ''}</textarea>
    <small class="form-text text-muted">Direct channel links or usernames</small>
</div>
<div class="mb-3">
    <label class="form-label">Blacklist (comma-separated)</label>
    <input type="text" class="form-control" name="stopwords"
        value="${config.stopwords || 'casino, abuz, dark, scam, porn, xxx, dating, naked'}"
        placeholder="casino, scam, porn">
    <small class="form-text text-muted">Channels containing these words in title will be skipped</small>
</div>
<div class="mb-3">
    <label class="form-label">Language</label>
    <select class="form-select" name="language">
        <option value="AUTO" ${config.language==='AUTO' ? 'selected' : '' }>Auto-detect</option>
        <option value="EN" ${config.language==='EN' ? 'selected' : '' }>English</option>
        <option value="RU" ${config.language==='RU' ? 'selected' : '' }>Russian</option>
    </select>
</div>
`;
}
else if (type === 'username') {
// Pre-fill Logic
const defaultUser = config.username || accountData.username;

html += `
<div class="mb-3">
    <label class="form-label">Set Username</label>
    <div class="input-group">
        <span class="input-group-text">@</span>
        <input type="text" class="form-control" name="username" value="${defaultUser}">
    </div>
</div>
`;
}

container.innerHTML = html;

// Attach upload handler for photo
if (type === 'photo') {
document.getElementById('photoInput').addEventListener('change', async function (e) {
if (e.target.files.length > 0) {
const formData = new FormData();
formData.append('file', e.target.files[0]);

try {
const btn = document.getElementById('saveNodeConfigBtn');
const originalText = btn.innerHTML;
btn.disabled = true;
btn.innerHTML = 'Uploading...';

const resp = await fetch('/scheduler/upload', {
method: 'POST',
body: formData
});
const data = await resp.json();

if (resp.ok) {
document.querySelector('input[name="photo_path"]').value = data.path;
document.getElementById('photoPreview').innerText = 'Uploaded: ' + data.filename;
} else {
alert('Upload failed: ' + data.error);
}

btn.disabled = false;
btn.innerHTML = originalText;
} catch (err) {
console.error(err);
alert('Upload error');
}
}
});
}
}

async function runNodeNow() {
if (!currentNode) return;

if (!confirm('Execute this node IMMEDIATELY?')) return;

// Temporarily grab current config from form just in case it wasn't saved yet
const form = document.getElementById('nodeConfigForm');
const formData = new FormData(form);
const tempConfig = {};
for (let [key, value] of formData.entries()) {
if (['execution_time', 'is_random_time'].includes(key)) continue;
tempConfig[key] = value;
}

const payload = {
node_type: currentNode.node_type,
config: tempConfig
};

// CLOSE MODAL IMMEDIATELY
configModal.hide();

// Show running status on node element in calendar
if (currentNode.el) {
currentNode.el.classList.add('executing');
const originalHTML = currentNode.el.innerHTML;
currentNode.el.innerHTML = `
<div class="d-flex align-items-center gap-2">
    <span class="spinner-border spinner-border-sm text-primary"></span>
    <strong>${getNodeLabel(currentNode.node_type)}</strong>
    <span class="badge bg-warning text-dark">Running...</span>
</div>
`;

try {
const resp = await fetch(`/scheduler/accounts/${schedulerAccountId}/run_node`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});

const data = await resp.json();

if (resp.ok) {
// Success - update node to show success
currentNode.el.classList.remove('executing');
currentNode.el.classList.add('node-success');
updateNodeVisuals(currentNode.el, currentNode, currentNodeDay);

// Show success toast
showToast('‚úÖ Success', `Node executed successfully! ${data.result || data.message || ''}`, 'success');
} else {
// Error - restore original and show error
currentNode.el.classList.remove('executing');
currentNode.el.classList.add('node-error');
currentNode.el.innerHTML = originalHTML;

showToast('‚ùå Error', data.error || 'Execution failed', 'danger');
}
} catch (err) {
console.error(err);
currentNode.el.classList.remove('executing');
currentNode.el.classList.add('node-error');
currentNode.el.innerHTML = originalHTML;

showToast('‚ùå Error', 'Execution error: ' + err.message, 'danger');
}
}
}

// Helper function to show Bootstrap toast notifications
function showToast(title, message, type = 'info') {
const toastContainer = document.getElementById('toast-container') || createToastContainer();

const toast = document.createElement('div');
toast.className = `toast align-items-center text-white bg-${type} border-0`;
toast.setAttribute('role', 'alert');
toast.innerHTML = `
<div class="d-flex">
    <div class="toast-body">
        <strong>${title}</strong><br>
        ${message}
    </div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
</div>
`;

toastContainer.appendChild(toast);
const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
bsToast.show();

// Remove from DOM after hidden
toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function createToastContainer() {
const container = document.createElement('div');
container.id = 'toast-container';
container.className = 'toast-container position-fixed top-0 end-0 p-3';
container.style.zIndex = '9999';
document.body.appendChild(container);
return container;
}

function saveConfig() {
if (!currentNode) return;

const form = document.getElementById('nodeConfigForm');

// Common
currentNode.execution_time = form.execution_time.value;
currentNode.is_random_time = form.is_random_time.checked;

// Dynamic
const formData = new FormData(form);
const newConfig = {};

for (let [key, value] of formData.entries()) {
if (['execution_time', 'is_random_time'].includes(key)) continue;
newConfig[key] = value;
}

currentNode.config = newConfig;

// Update UI
if (currentNode.el) {
updateNodeVisuals(currentNode.el, currentNode, currentNodeDay);
}

configModal.hide();
}

async function loadSchedule() {
try {
const response = await fetch(`/scheduler/accounts/${schedulerAccountId}/schedule`);
const data = await response.json();

if (data.schedule) {
scheduleData.schedule_id = data.schedule.id;
scheduleData.nodes = data.nodes || [];

// Render existing nodes
data.nodes.forEach(node => {
renderNode(node, node.day_number);
});
}
} catch (error) {
console.error('Error loading schedule:', error);
}
}

async function saveSchedule() {
try {
// Create schedule if doesn't exist
if (!scheduleData.schedule_id) {
const createResp = await fetch(`/scheduler/accounts/${schedulerAccountId}/schedule`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'Warmup Schedule' })
});
const createData = await createResp.json();
scheduleData.schedule_id = createData.schedule.id;
}

// Save each node
// Note: simple implementation re-sends everything.
// Better: update existing, create new.
// But current backend 'add_node' is POST.
// We should probably wipe and recreate or track IDs.
// Existing 'scheduleData.nodes' items from loadSchedule HAVE IDs. Items added locally DO NOT.

// For now, let's just loop. The backend doesn't seem to enforce uniqueness/overwrite.
// Actually `add_node` creates new DB rows.
// Repeated saving will duplicate nodes if we don't handle IDs!

// FIX: We need to differentiate Update vs Create.
// Nodes from load have .id. New nodes don't.

for (const node of scheduleData.nodes) {
if (node.id) {
await fetch(`/scheduler/nodes/${node.id}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(node)
});
} else {
const resp = await fetch(`/scheduler/schedules/${scheduleData.schedule_id}/nodes`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(node)
});
const data = await resp.json();
if (data.node) {
node.id = data.node.id; // Update local ID
}
}
}

// Also need to handle deleted nodes?
// The current local delete removes from array.
// But if it had an ID, we never told backend to delete it.
// We should track deleted IDs.
// Skipping complex sync for this MVP step, but worth noting.

alert('Schedule saved successfully!');
} catch (error) {
console.error('Error saving schedule:', error);
alert('Error saving schedule');
}
}

// Add deleted node tracking
let deletedNodeIds = [];
const _originalRemove = window.removeSchedulerNode;
window.removeSchedulerNode = function (el, dayNumber, nodeType) {
const nodeEl = el.parentElement;
if (nodeEl._nodeObj && nodeEl._nodeObj.id) {
deletedNodeIds.push(nodeEl._nodeObj.id);
}
_originalRemove(el, dayNumber, nodeType);
};

// Patch saveSchedule to handle deletes
const _originalSave = saveSchedule;
saveSchedule = async function () {
try {
// Process deletes first
for (const id of deletedNodeIds) {
await fetch(`/scheduler/nodes/${id}`, { method: 'DELETE' });
}
deletedNodeIds = []; // Clear processed

// Return to main save (create/update)
// Re-implementing simplified version of above logic here to include context

if (!scheduleData.schedule_id) {
const createResp = await fetch(`/scheduler/accounts/${schedulerAccountId}/schedule`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'Warmup Schedule' })
});
const createData = await createResp.json();
scheduleData.schedule_id = createData.schedule.id;
}

for (const node of scheduleData.nodes) {
if (node.id) {
await fetch(`/scheduler/nodes/${node.id}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(node)
});
} else {
const resp = await fetch(`/scheduler/schedules/${scheduleData.schedule_id}/nodes`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(node)
});
const data = await resp.json();
if (data.node) {
node.id = data.node.id;
}
}
}
alert('Schedule saved successfully!');

} catch (e) {
console.error(e);
alert('Error saving: ' + e);
}
}


async function startSchedule() {
if (!scheduleData.schedule_id) {
alert('Please save schedule first');
return;
}

if (confirm('Start warmup schedule? This will begin automated execution.')) {
try {
const response = await fetch(`/scheduler/schedules/${scheduleData.schedule_id}/start`, {
method: 'POST'
});
const data = await response.json();
alert('Schedule started!');
location.reload();
} catch (error) {
console.error('Error starting schedule:', error);
alert('Error starting schedule');
}
}
}

// Button handlers
document.getElementById('save-schedule-btn').addEventListener('click', saveSchedule);
document.getElementById('start-schedule-btn').addEventListener('click', startSchedule);
document.getElementById('clear-schedule-btn').addEventListener('click', function () {
if (confirm('Clear all nodes from schedule?')) {
// Track all for deletion
scheduleData.nodes.forEach(n => {
if (n.id) deletedNodeIds.push(n.id);
});
scheduleData.nodes = [];
document.querySelectorAll('.day-nodes').forEach(el => el.innerHTML = '');
}
});
}) ();
</script>