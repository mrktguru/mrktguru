<!-- Warmup Scheduler Section -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ðŸ”¥ Warmup Scheduler</h5>
        <div>
            <button class="btn btn-sm btn-light" id="save-schedule-btn">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-sm btn-success" id="start-schedule-btn">
                <i class="bi bi-play-fill"></i> Start
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            <!-- Node Library Sidebar -->
            <div class="col-md-3 border-end p-3" style="background-color: #f8f9fa;">
                <h6 class="mb-3">ðŸ“¦ Available Nodes</h6>
                <p class="text-muted small">Drag nodes to calendar</p>

                <!-- Profile Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">ðŸ‘¤ Profile</strong>
                    <div class="node-item draggable mb-2" data-node-type="bio">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-person-badge"></i> Bio
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="username">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-at"></i> Username
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="photo">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-camera"></i> Photo
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="sync_profile">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-arrow-repeat"></i> Sync Profile
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="set_2fa">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-shield-lock"></i> Set 2FA
                        </div>
                    </div>
                </div>

                <!-- Contact Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">ðŸ“ž Contacts</strong>
                    <div class="node-item draggable mb-2" data-node-type="import_contacts">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-person-plus"></i> Import
                        </div>
                    </div>
                    <!-- Search & Filter -->
                    <div class="node-item draggable mb-2" data-node-type="search_filter">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-search"></i> Search & Filter
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="send_message">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-chat"></i> Send Message
                        </div>
                    </div>
                </div>

                <!-- Channel Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">ðŸ“º Channels</strong>
                    <div class="node-item draggable mb-2" data-node-type="subscribe">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-bookmark-plus"></i> Subscribe
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="visit">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-eye"></i> Visit
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="smart_subscribe">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-bell-fill"></i> Smart Subscribe
                        </div>
                    </div>
                </div>

                <!-- Other Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">ðŸ’¤ Other</strong>
                    <div class="node-item draggable mb-2" data-node-type="idle">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-moon"></i> Idle
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="passive_activity">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-cup-hot"></i> Passive Activity
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9 p-3">
                <!-- Control Bar -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-outline-secondary btn-sm" id="prev-week-btn">
                            <i class="bi bi-chevron-left"></i> Prev
                        </button>
                        <h6 class="mb-0" id="current-week-label">Week 1 (Days 1-7)</h6>
                        <button class="btn btn-outline-secondary btn-sm" id="next-week-btn">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="clear-schedule-btn">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                </div>

                <!-- Time-Grid Container -->
                <div id="scheduler-calendar" class="scheduler-calendar scheduler-container border rounded"
                    style="position: relative; background: #fff;" data-account-id="{{ account.id }}"
                    data-created-at="{{ account.created_at.isoformat() if account.created_at else '' }}"
                    data-start-date="{{ account.active_schedule.start_date.isoformat() if account.active_schedule and account.active_schedule.start_date else (account.created_at.isoformat() if account.created_at else '') }}"
                    data-bio="{{ account.bio | default('', true) | e }}"
                    data-username="{{ account.username | default('', true) | e }}"
                    data-first-name="{{ account.first_name | default('', true) | e }}"
                    data-photo-url="{{ account.photo_url | default('', true) | e }}">

                    <!-- Sticky Header: Day Labels -->
                    <div class="d-flex border-bottom bg-light sticky-top" style="z-index: 10;">
                        <div class="time-column-header border-end" style="width: 60px; flex-shrink: 0;"></div>
                        <!-- Time label spacer -->
                        <!-- Dynamic Day Headers injected here -->
                        <div id="day-header-row" class="d-flex flex-grow-1"></div>
                    </div>

                    <!-- Scrollable Grid Body -->
                    <div class="d-flex position-relative">
                        <!-- Time Labels Column -->
                        <div id="time-labels-col" class="border-end bg-light" style="width: 60px; flex-shrink: 0;">
                        </div>

                        <!-- Main Grid (Slots + Nodes) -->
                        <div id="main-grid-area" class="position-relative flex-grow-1">
                            <!-- Grid Background (Lines) -->
                            <div id="grid-background" class="w-100 h-100 position-absolute top-0 start-0"></div>

                            <!-- Events Container (Nodes overlay) -->
                            <div id="events-container" class="w-100 h-100 position-absolute top-0 start-0"
                                style="pointer-events: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .scheduler-calendar {
                    min-height: 400px;
                }

                .day-cell {
                    border: 2px dashed #dee2e6;
                    border-radius: 8px;
                    min-height: 150px;
                    padding: 8px;
                    background: white;
                    transition: all 0.2s;
                }

                .day-cell.drag-over {
                    border-color: #0d6efd;
                    background-color: #e7f1ff;
                }

                .day-header {
                    font-weight: bold;
                    font-size: 0.875rem;
                    color: #6c757d;
                    margin-bottom: 8px;
                    padding-bottom: 4px;
                    border-bottom: 1px solid #dee2e6;
                }

                .day-nodes {
                    min-height: 100px;
                }

                .node-item.draggable {
                    cursor: move;
                    user-select: none;
                }

                .node-item.draggable:hover {
                    opacity: 0.8;
                }

                .scheduled-node {
                    background: #e7f1ff;
                    border: 1px solid #0d6efd;
                    border-radius: 4px;
                    padding: 6px 8px;
                    margin-bottom: 6px;
                    font-size: 0.8rem;
                    cursor: pointer;
                    position: relative;
                }

                .scheduled-node:hover {
                    background: #cfe2ff;
                }

                .scheduled-node .remove-node {
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    cursor: pointer;
                    color: #dc3545;
                    font-size: 0.75rem;
                }

                .scheduled-node .node-time {
                    font-size: 0.7rem;
                    color: #6c757d;
                    display: block;
                }

                .node-config-modal {
                    padding: 1rem;
                    max-height: 80vh;
                    overflow-y: auto;
                }

                /* Executing state */
                .scheduled-node.executing {
                    background: #fff3cd !important;
                    border-color: #ffc107 !important;
                    animation: pulse 1.5s infinite;
                }

                /* Completed/History state */
                .scheduled-node.node-completed {
                    background: #e9ecef !important;
                    /* Gray */
                    border-color: #dee2e6 !important;
                    color: #6c757d;
                    cursor: default !important;
                }

                /* Hide remove button for completed nodes */
                .scheduled-node.node-completed .node-remove-btn {
                    display: none !important;
                }

                /* Error state */
                .scheduled-node.node-error {
                    background: #f8d7da !important;
                    border-color: #dc3545 !important;
                }

                @keyframes pulse {

                    0%,
                    100% {
                        opacity: 1;
                    }

                    50% {
                        opacity: 0.7;
                    }
                }

                /* Supernode Styles */
                .supernode-wrapper {
                    position: absolute;
                    width: 95%;
                    border: 2px solid #6f42c1;
                    /* Bootstrap purple */
                    background-color: rgba(111, 66, 193, 0.05);
                    border-radius: 6px;
                    padding: 24px 4px 4px 4px;
                    /* Space for label */
                    z-index: 50;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    transition: all 0.2s ease;
                }

                .supernode-label {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    background-color: #6f42c1;
                    color: white;
                    font-size: 0.7rem;
                    font-weight: bold;
                    text-transform: uppercase;
                    padding: 1px 6px;
                    border-top-left-radius: 4px;
                    border-top-right-radius: 4px;
                    display: flex;
                    justify-content: space-between;
                }

                .supernode-wrapper:hover {
                    z-index: 100;
                    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
                }

                /* Nodes inside supernode override */
                .supernode-wrapper .scheduled-node {
                    position: relative !important;
                    left: 0 !important;
                    top: 0 !important;
                    width: 100% !important;
                    margin-bottom: 4px;
                    height: auto !important;
                    min-height: 40px;
                }
            </style>

            <!-- Node Configuration Modal -->
            <div class="modal fade" id="nodeConfigModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Configure Node</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="nodeConfigForm">
                                <!-- Common Fields -->
                                <div class="mb-3">
                                    <label class="form-label">Execution Time (24h)</label>
                                    <div class="d-flex gap-2">
                                        <input type="text" class="form-control" name="execution_time"
                                            placeholder="23:30" pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]">
                                        <div class="form-check d-flex align-items-center">
                                            <input class="form-check-input me-2" type="checkbox" name="is_random_time"
                                                id="isRandomTime">
                                            <label class="form-check-label" for="isRandomTime">Random</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dynamic Fields Container -->
                                <div id="dynamicFields"></div>
                            </form>
                        </div>
                        <div class="modal-footer justify-content-between">
                            <div>
                                <button type="button" class="btn btn-warning" id="runNodeNowBtn">
                                    <i class="bi bi-lightning-fill"></i> Run Now
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveNodeConfigBtn">Save
                                    Configuration</button>

                                <!-- Scheduler JavaScript - loaded from external file -->
                                <script
                                    src="{{ url_for('static', filename='js/scheduler.js') }}?v=status_colors_v46"></script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const accountId = "{{ account.id }}";
        const terminal = document.getElementById('terminal-content');
        const badge = document.getElementById('log-status-badge');
        let eventSource = null;

        function connectLogs() {
            if (eventSource) eventSource.close();

            // Clear initially? Maybe keep "Waiting" text until first log
            // terminal.innerHTML = ''; 

            eventSource = new EventSource(`/scheduler/stream/logs/${accountId}`);

            eventSource.onopen = () => {
                badge.className = 'badge bg-success';
                badge.innerText = 'LIVE';
                // Only append if terminal has "Waiting..."
                if (terminal.innerText.includes('Waiting')) terminal.innerHTML = '';
                appendLine({ timestamp: new Date().toLocaleTimeString(), level: 'SYSTEM', message: 'Connection established.' }, true);
            };

            eventSource.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    appendLine(data);
                } catch (err) {
                    console.error('Log parse error', err);
                }
            };

            eventSource.onerror = () => {
                badge.className = 'badge bg-danger';
                badge.innerText = 'RECONNECTING';
                // EventSource retries automatically
            };
        }

        function appendLine(log, isSystem = false) {
            const row = document.createElement('div');
            row.style.marginBottom = '2px';
            row.style.lineHeight = '1.2';
            row.style.wordWrap = 'break-word';

            // Colors
            let color = '#d4d4d4'; // Default text
            let levelColor = '#808080';

            if (log.level === 'INFO') { levelColor = '#569cd6'; }
            else if (log.level === 'WARNING') { levelColor = '#ce9178'; color = '#ce9178'; }
            else if (log.level === 'ERROR' || log.level === 'CRITICAL') { levelColor = '#f44747'; color = '#f44747'; }
            else if (isSystem) { color = '#6a9955'; }

            // Format: [TIME] [LEVEL] Message
            row.innerHTML = `
                <span style="color: #6a9955; margin-right: 5px; opacity:0.7;">[${log.timestamp}]</span>
                <span style="color: ${levelColor}; font-weight: bold; min-width: 50px; display: inline-block;">${log.level}</span>
                <span style="color: ${color};">${log.raw_message || log.message}</span>
            `;

            terminal.appendChild(row);

            // Auto-scroll
            const autoscroll = document.getElementById('autoscroll-switch').checked;
            if (autoscroll) {
                terminal.scrollTop = terminal.scrollHeight;
            }
        }

        // Start connection
        if (accountId) connectLogs();
    });
</script>