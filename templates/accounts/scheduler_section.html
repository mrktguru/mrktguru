<!-- Warmup Scheduler Section -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üî• Warmup Scheduler</h5>
        <div>
            <button class="btn btn-sm btn-warning" id="ai-planner-btn" data-bs-toggle="modal" data-bs-target="#aiPlannerModal">
                <i class="bi bi-robot"></i> AI Planner
            </button>
            <button class="btn btn-sm btn-light" id="save-schedule-btn">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-sm btn-success" id="start-schedule-btn">
                <i class="bi bi-play-fill"></i> Start
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            <!-- Node Library Sidebar -->
            <div class="col-md-3 border-end p-3" style="background-color: #f8f9fa;">
                <h6 class="mb-3">üì¶ Available Nodes</h6>
                <p class="text-muted small">Drag nodes to calendar</p>

                <!-- Profile Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üë§ Profile</strong>
                    <div class="node-item draggable mb-2" data-node-type="bio">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-person-badge"></i> Bio
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="username">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-at"></i> Username
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="photo">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-camera"></i> Photo
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="sync_profile">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-arrow-repeat"></i> Sync Profile
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="set_2fa">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-shield-lock"></i> Set 2FA
                        </div>
                    </div>
                </div>

                <!-- Contact Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üìû Contacts</strong>
                    <div class="node-item draggable mb-2" data-node-type="import_contacts">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-person-plus"></i> Import
                        </div>
                    </div>
                    <!-- Search & Filter -->
                    <div class="node-item draggable mb-2" data-node-type="search_filter">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-search"></i> Search & Filter
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="send_message">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-chat"></i> Send Message
                        </div>
                    </div>
                </div>

                <!-- Channel Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üì∫ Channels</strong>
                    <div class="node-item draggable mb-2" data-node-type="subscribe">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-bookmark-plus"></i> Subscribe
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="visit">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-eye"></i> Visit
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="smart_subscribe">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-bell-fill"></i> Smart Subscribe
                        </div>
                    </div>
                </div>

                <!-- Other Nodes -->
                <div class="mb-3">
                    <strong class="d-block mb-2">üí§ Other</strong>
                    <div class="node-item draggable mb-2" data-node-type="idle">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-moon"></i> Idle
                        </div>
                    </div>
                    <div class="node-item draggable mb-2" data-node-type="passive_activity">
                        <div class="card card-body p-2 small">
                            <i class="bi bi-cup-hot"></i> Passive Activity
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9 p-3">
                <!-- Control Bar -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-outline-secondary btn-sm" id="prev-week-btn">
                            <i class="bi bi-chevron-left"></i> Prev
                        </button>
                        <h6 class="mb-0" id="current-week-label">Week 1 (Days 1-7)</h6>
                        <button class="btn btn-outline-secondary btn-sm" id="next-week-btn">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="clear-schedule-btn">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                </div>

                <!-- Time-Grid Container -->
                <div id="scheduler-calendar" class="scheduler-calendar scheduler-container border rounded"
                    style="position: relative; background: #fff;" data-account-id="{{ account.id }}"
                    data-created-at="{{ account.created_at.isoformat() if account.created_at else '' }}"
                    data-start-date="{{ account.active_schedule.start_date.isoformat() if account.active_schedule and account.active_schedule.start_date else (account.created_at.isoformat() if account.created_at else '') }}"
                    data-bio="{{ account.bio | default('', true) | e }}"
                    data-username="{{ account.username | default('', true) | e }}"
                    data-first-name="{{ account.first_name | default('', true) | e }}"
                    data-photo-url="{{ account.photo_url | default('', true) | e }}">

                    <!-- Sticky Header: Day Labels -->
                    <div class="d-flex border-bottom bg-light sticky-top" style="z-index: 10;">
                        <div class="time-column-header border-end" style="width: 60px; flex-shrink: 0;"></div>
                        <!-- Time label spacer -->
                        <!-- Dynamic Day Headers injected here -->
                        <div id="day-header-row" class="d-flex flex-grow-1"></div>
                    </div>

                    <!-- Scrollable Grid Body -->
                    <div class="d-flex position-relative">
                        <!-- Time Labels Column -->
                        <div id="time-labels-col" class="border-end bg-light" style="width: 60px; flex-shrink: 0;">
                        </div>

                        <!-- Main Grid (Slots + Nodes) -->
                        <div id="main-grid-area" class="position-relative flex-grow-1">
                            <!-- Grid Background (Lines) -->
                            <div id="grid-background" class="w-100 h-100 position-absolute top-0 start-0"></div>

                            <!-- Events Container (Nodes overlay) -->
                            <div id="events-container" class="w-100 h-100 position-absolute top-0 start-0"
                                style="pointer-events: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .scheduler-calendar {
                    min-height: 400px;
                }

                .day-cell {
                    border: 2px dashed #dee2e6;
                    border-radius: 8px;
                    min-height: 150px;
                    padding: 8px;
                    background: white;
                    transition: all 0.2s;
                }

                .day-cell.drag-over {
                    border-color: #0d6efd;
                    background-color: #e7f1ff;
                }

                .day-header {
                    font-weight: bold;
                    font-size: 0.875rem;
                    color: #6c757d;
                    margin-bottom: 8px;
                    padding-bottom: 4px;
                    border-bottom: 1px solid #dee2e6;
                }

                .day-nodes {
                    min-height: 100px;
                }

                .node-item.draggable {
                    cursor: move;
                    user-select: none;
                }

                .node-item.draggable:hover {
                    opacity: 0.8;
                }

                .scheduled-node {
                    background: #e7f1ff;
                    border: 1px solid #0d6efd;
                    border-radius: 4px;
                    padding: 6px 8px;
                    margin-bottom: 6px;
                    font-size: 0.8rem;
                    cursor: pointer;
                    position: relative;
                }

                .scheduled-node:hover {
                    background: #cfe2ff;
                }

                .scheduled-node .remove-node {
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    cursor: pointer;
                    color: #dc3545;
                    font-size: 0.75rem;
                }

                .scheduled-node .node-time {
                    font-size: 0.7rem;
                    color: #6c757d;
                    display: block;
                }

                .node-config-modal {
                    padding: 1rem;
                    max-height: 80vh;
                    overflow-y: auto;
                }

                /* Executing/Running state */
                .scheduled-node.node-running {
                    background-color: #cfe2ff !important;
                    border-color: #0d6efd !important;
                    animation: pulse 2s infinite;
                }

                /* Ready/Pending state */
                .scheduled-node.node-ready {
                    background-color: #d1e7dd !important;
                    border-color: #198754 !important;
                    color: #0f5132;
                }

                /* Completed/History state */
                .scheduled-node.node-completed {
                    background-color: #e9ecef !important;
                    border-color: #dee2e6 !important;
                    color: #6c757d;
                    cursor: default !important;
                }

                /* Skipped state */
                .scheduled-node.node-skipped {
                    background-color: #f8f9fa !important;
                    border-color: #adb5bd !important;
                    color: #6c757d;
                    opacity: 0.8;
                }

                /* Queued state - waiting in supernode */
                .scheduled-node.node-queued {
                    background-color: #e2e3f0 !important;
                    border-color: #6610f2 !important;
                    color: #6610f2;
                    border-style: dashed !important;
                }

                /* Failed/Error state */
                .scheduled-node.node-failed {
                    background-color: #f8d7da !important;
                    border-color: #dc3545 !important;
                    color: #842029;
                }

                /* Draft state */
                .scheduled-node.node-draft {
                    background-color: #fff3cd !important;
                    border-color: #ffc107 !important;
                    color: #664d03;
                }

                @keyframes pulse {

                    0%,
                    100% {
                        opacity: 1;
                    }

                    50% {
                        opacity: 0.7;
                    }
                }

                /* Supernode Styles */
                .supernode-wrapper {
                    position: absolute;
                    width: 95%;
                    border: 2px solid #6f42c1;
                    /* Bootstrap purple */
                    background-color: rgba(111, 66, 193, 0.05);
                    border-radius: 6px;
                    padding: 22px 4px 4px 4px;
                    /* Space for label */
                    z-index: 50;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    transition: all 0.2s ease;
                }

                .supernode-label {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    background-color: #6f42c1;
                    color: white;
                    font-size: 0.65rem;
                    font-weight: bold;
                    text-transform: none;
                    padding: 2px 6px;
                    border-top-left-radius: 4px;
                    border-top-right-radius: 4px;
                    display: flex;
                    justify-content: space-between;
                }

                .supernode-wrapper:hover {
                    z-index: 100;
                    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
                }

                /* Nodes inside supernode override */
                .supernode-wrapper .scheduled-node {
                    position: relative !important;
                    left: 0 !important;
                    top: 0 !important;
                    width: 100% !important;
                    margin-bottom: 4px;
                    height: auto !important;
                    min-height: 40px;
                }
            </style>

            <!-- Node Configuration Modal -->
            <div class="modal fade" id="nodeConfigModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Configure Node</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="nodeConfigForm">
                                <!-- Common Fields -->
                                <div class="mb-3">
                                    <label class="form-label">Execution Time (24h)</label>
                                    <div class="d-flex gap-2">
                                        <input type="text" class="form-control" name="execution_time"
                                            placeholder="23:30" pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]">
                                        <div class="form-check d-flex align-items-center">
                                            <input class="form-check-input me-2" type="checkbox" name="is_random_time"
                                                id="isRandomTime">
                                            <label class="form-check-label" for="isRandomTime">Random</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dynamic Fields Container -->
                                <div id="dynamicFields"></div>
                            </form>
                        </div>
                        <div class="modal-footer justify-content-between">
                            <div>
                                <button type="button" class="btn btn-warning" id="runNodeNowBtn">
                                    <i class="bi bi-lightning-fill"></i> Run Now
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveNodeConfigBtn">Save
                                    Configuration</button>

                                <!-- Scheduler JavaScript - loaded from external file -->
                                <script
                                    src="{{ url_for('static', filename='js/modules/scheduler/index.js') }}?v=refactor_v1"
                                    type="module"></script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Planner Modal -->
<div class="modal fade" id="aiPlannerModal" tabindex="-1" aria-labelledby="aiPlannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="aiPlannerModalLabel">
                    <i class="bi bi-robot"></i> AI Schedule Generator
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Persona Info -->
                <div class="alert alert-info mb-3" id="aiPersonaInfo">
                    <small class="text-muted">Loading persona...</small>
                </div>
                
                <form id="aiPlannerForm">
                    <!-- Node Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Nodes:</label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="passive_activity" id="node_passive" checked>
                                    <label class="form-check-label" for="node_passive">
                                        <i class="bi bi-cup-hot"></i> Passive Activity
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="channel_search" id="node_search">
                                    <label class="form-check-label" for="node_search">
                                        <i class="bi bi-search"></i> Channel Search
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="subscribe" id="node_subscribe">
                                    <label class="form-check-label" for="node_subscribe">
                                        <i class="bi bi-bookmark-plus"></i> Subscribe
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="visit" id="node_visit">
                                    <label class="form-check-label" for="node_visit">
                                        <i class="bi bi-eye"></i> Visit Channels
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Period -->
                    <div class="mb-3">
                        <label for="aiPeriodDays" class="form-label fw-bold">Period:</label>
                        <select class="form-select" id="aiPeriodDays">
                            <option value="1">1 Day</option>
                            <option value="3">3 Days</option>
                            <option value="7" selected>7 Days</option>
                            <option value="14">14 Days</option>
                        </select>
                    </div>
                    
                    <!-- Tier -->
                    <div class="mb-3">
                        <label for="aiTierSelect" class="form-label fw-bold">Intensity:</label>
                        <select class="form-select" id="aiTierSelect">
                            <!-- Loaded dynamically -->
                        </select>
                        <small class="text-muted" id="aiTierDescription"></small>
                    </div>
                    
                    <!-- Topic (readonly, from account) -->
                    <div class="mb-3">
                        <label for="aiTopicDisplay" class="form-label fw-bold">Topic:</label>
                        <input type="text" class="form-control" id="aiTopicDisplay" readonly>
                        <small class="text-muted">Change in account settings</small>
                    </div>
                </form>
                
                <!-- Info Box -->
                <div class="alert alert-secondary">
                    <i class="bi bi-lightbulb"></i> 
                    AI will generate a human-like schedule based on the account's persona, timezone, and selected intensity level.
                    Times will be slightly irregular (e.g., 14:07 instead of 14:00) to appear more natural.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="generateScheduleBtn">
                    <i class="bi bi-magic"></i> Generate Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // AI Planner Script
    document.addEventListener('DOMContentLoaded', function () {
        const accountId = "{{ account.id }}";
        const aiModal = document.getElementById('aiPlannerModal');
        const generateBtn = document.getElementById('generateScheduleBtn');
        const tierSelect = document.getElementById('aiTierSelect');
        const tierDescription = document.getElementById('aiTierDescription');
        const topicDisplay = document.getElementById('aiTopicDisplay');
        const personaInfo = document.getElementById('aiPersonaInfo');
        
        let tiersData = [];
        
        // Load data when modal opens
        aiModal.addEventListener('show.bs.modal', async function () {
            await loadTiers();
            await loadPersona();
        });
        
        // Load tiers
        async function loadTiers() {
            try {
                const resp = await fetch('/api/ai/tiers');
                const data = await resp.json();
                if (data.success) {
                    tiersData = data.tiers;
                    tierSelect.innerHTML = data.tiers.map(t => 
                        `<option value="${t.slug}">${t.name}</option>`
                    ).join('');
                    updateTierDescription();
                }
            } catch (e) {
                console.error('Failed to load tiers:', e);
            }
        }
        
        // Load persona
        async function loadPersona() {
            try {
                const resp = await fetch(`/api/ai/persona/${accountId}`);
                const data = await resp.json();
                if (data.success && data.persona) {
                    const p = data.persona;
                    personaInfo.innerHTML = `
                        <strong>üé≠ Persona:</strong> ${p.name}, ${p.age}y, ${p.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}
                        <br><small>üìç ${p.timezone_offset} | üéØ ${p.topic_name}</small>
                    `;
                    topicDisplay.value = p.topic_name || 'General';
                }
            } catch (e) {
                console.error('Failed to load persona:', e);
                personaInfo.innerHTML = '<small class="text-danger">Failed to load persona</small>';
            }
        }
        
        // Update tier description
        tierSelect.addEventListener('change', updateTierDescription);
        function updateTierDescription() {
            const tier = tiersData.find(t => t.slug === tierSelect.value);
            if (tier) {
                tierDescription.textContent = `${tier.min_sessions}-${tier.max_sessions} sessions/day, ${tier.total_minutes_min}-${tier.total_minutes_max} min total`;
            }
        }
        
        // Generate schedule
        generateBtn.addEventListener('click', async function () {
            const selectedNodes = [];
            document.querySelectorAll('#aiPlannerForm input[type="checkbox"]:checked').forEach(cb => {
                selectedNodes.push(cb.value);
            });
            
            if (selectedNodes.length === 0) {
                alert('Please select at least one node type');
                return;
            }
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
            
            try {
                const resp = await fetch(`/api/ai/generate_schedule/${accountId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tier: tierSelect.value,
                        days: parseInt(document.getElementById('aiPeriodDays').value),
                        node_types: selectedNodes
                    })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    alert(`‚úÖ Schedule generated! ${data.nodes_created} nodes created.`);
                    // Close modal and refresh calendar
                    bootstrap.Modal.getInstance(aiModal).hide();
                    location.reload(); // Simple refresh for now
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Generation error:', e);
                alert('‚ùå Failed to generate schedule');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Schedule';
            }
        });
    });
</script>

<script>
    // Note: Log terminal connection is handled by detail.html 
    // This script only contains scheduler-specific logic
    document.addEventListener('DOMContentLoaded', function () {
        const accountId = "{{ account.id }}";
        // Scheduler-specific initialization can go here if needed
    });
</script>