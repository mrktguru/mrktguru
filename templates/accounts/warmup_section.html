<!-- Warmup System Section -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üî• Account Warmup</h5>
    </div>
    <div class="card-body">
        <!-- Progress Bar -->
        <div class="warmup-progress mb-3">
            <div class="progress">
                <div class="progress-bar" style="width: 0%" id="warmup-progress-bar">0%</div>
            </div>
            <small class="text-muted">Stage 1/4: Profile</small>
        </div>

        <!-- Warmup Stages Accordion -->
        <div class="accordion" id="warmupAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#stage1">
                        <span class="badge bg-secondary me-2">1</span>
                        Stage 1: Profile Setup
                    </button>
                </h2>
                <div id="stage1" class="accordion-collapse collapse show" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <!-- Manual Settings -->
                        <h6>Manual Settings</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Privacy - Phone</label>
                                <select class="form-select" id="privacy-phone">
                                    <option value="nobody">Nobody</option>
                                    <option value="contacts">My Contacts</option>
                                    <option value="everybody">Everybody</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Language</label>
                                <select class="form-select" id="language">
                                    <option value="en">English</option>
                                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="first-name"
                                    value="{{ account.first_name or '' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label>Last Name</label>
                                <input type="text" class="form-control" id="last-name"
                                    value="{{ account.last_name or '' }}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Bio</label>
                            <textarea class="form-control" id="bio" rows="2">{{ account.bio or '' }}</textarea>
                        </div>
                        <ul class="text-muted">
                            <li>Importing contacts</li>
                            <li>Viewing contact list</li>
                            <li>Saving to Saved Messages</li>
                        </ul>
                        <p class="text-muted mb-0">
                            <strong>Status:</strong> Optional - Coming soon
                        </p>
                        <div class="mb-3">
                            <label>Photo</label>
                            <input type="file" class="form-control" id="photo" accept="image/*">
                        </div>

                        <button class="btn btn-primary" onclick="executeProfile()">
                            <i class="bi bi-play-fill"></i> Execute Stage 1
                        </button>
                    </div>
                </div>
            </div>


            <!-- Stage 2: Contacts -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#stage2">
                        <span class="badge bg-secondary me-2">2</span>
                        Stage 2: Contacts
                    </button>
                </h2>
                <div id="stage2" class="accordion-collapse collapse" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <h6>Contact Activities</h6>
                        <div class="mb-3">
                            <label for="contact-phones">Phone Numbers (one per line)</label>
                            <textarea class="form-control" id="contact-phones" rows="3"
                                placeholder="+79123456789&#10;+79987654321"></textarea>
                            <small class="text-muted">Importing contacts helps build account trust.</small>
                        </div>

                        <ul class="text-muted small">
                            <li><i class="bi bi-check2"></i> Importing provided contacts</li>
                            <li><i class="bi bi-check2"></i> Viewing account contact list</li>
                            <li><i class="bi bi-check2"></i> Sending test message to "Saved Messages"</li>
                        </ul>

                        <button class="btn btn-primary" onclick="executeContacts()">
                            <i class="bi bi-play-fill"></i> Execute Stage 2
                        </button>
                    </div>
                </div>
            </div>
            <!-- Stage 3: Subscriptions -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#stage3">
                        <span class="badge bg-secondary me-2">3</span>
                        Stage 3: Subscriptions
                    </button>
                </h2>
                <div id="stage3" class="accordion-collapse collapse" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <!-- Channel Search -->
                        <h6>Search Channels</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="channel-search-query"
                                placeholder="Enter channel name or keyword">
                            <button class="btn btn-primary" onclick="searchChannels()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>

                        <!-- Search Results -->
                        <div id="search-results" style="display:none">
                            <h6>Search Results</h6>
                            <div id="results-list" class="list-group mb-3"></div>
                        </div>

                        <!-- Selected Channels -->
                        <div id="selected-channels">
                            <h6>Selected Channels (<span id="channel-count">0</span>)</h6>
                            <div id="channels-list"></div>
                        </div>

                        <button class="btn btn-success" onclick="executeChannels()" disabled id="execute-channels-btn">
                            <i class="bi bi-play-fill"></i> Execute Stage 3
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stage 4: Activity -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#stage4">
                        <span class="badge bg-secondary me-2">4</span>
                        Stage 4: Activity
                    </button>
                </h2>
                <div id="stage4" class="accordion-collapse collapse" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <p class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Stage 4 (Activity & Engagement) will include:
                        </p>
                        <ul class="text-muted">
                            <li>Viewing feed and stories</li>
                            <li>Reacting to posts</li>
                            <li>Interacting with bots</li>
                            <li>Joining groups</li>
                        </ul>
                        <p class="text-muted mb-0">
                            <strong>Status:</strong> Coming soon
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto">
            <table class="table table-sm table-hover mb-0" id="logs-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 130px;">Time</th>
                        <th style="width: 100px;">Action</th>
                        <th style="width: 90px;">Category</th>
                        <th style="width: 80px;">Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>
    // Warmup JavaScript Functions
    const accountId = {{ account.id }};

    // Execute Profile Setup
    async function executeProfile() {
        const data = {
            first_name: document.getElementById('first-name').value,
            last_name: document.getElementById('last-name').value,
            bio: document.getElementById('bio').value,
            privacy_phone: document.getElementById('privacy-phone').value,
            language: document.getElementById('language').value
        };

        if (!data.first_name) {
            alert('First name is required');
            return;
        }

        try {
            const response = await fetch(`/accounts/${accountId}/warmup/execute-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert('‚úÖ Profile setup completed! Reloading to update info...');
                location.reload();
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (e) {
            alert('‚ùå Error: ' + e.message);
        }
    }

    // Execute Contacts Setup
    async function executeContacts() {
        const phonesText = document.getElementById('contact-phones').value;
        const phones = phonesText.split('\n').map(p => p.trim()).filter(p => p.length > 0);

        try {
            const response = await fetch(`/accounts/${accountId}/warmup/execute-contacts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phones })
            });

            const result = await response.json();

            if (result.success) {
                alert('‚úÖ Contacts warmup completed!');
                location.reload();
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (e) {
            console.error('Contacts execution error:', e);
            alert('‚ùå Error: ' + e.message);
        }
    }

    // Search Channels
    async function searchChannels() {
        const query = document.getElementById('channel-search-query').value;

        if (!query) {
            alert('Enter a search query');
            return;
        }

        try {
            const response = await fetch(`/accounts/${accountId}/warmup/search-channels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            const result = await response.json();

            if (result.success) {
                displaySearchResults(result.results);
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (e) {
            alert('‚ùå Error: ' + e.message);
        }
    }

    // Display Search Results
    function displaySearchResults(results) {
        const container = document.getElementById('results-list');
        container.innerHTML = '';

        results.forEach(channel => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
            <div>
                <strong>@${channel.username}</strong>
                <br><small>${channel.title} ‚Ä¢ ${channel.participants_count} members</small>
            </div>
            <button class="btn btn-sm btn-primary" onclick='addChannel(${JSON.stringify(channel)})'>
                Add
            </button>
        `;
            container.appendChild(item);
        });

        document.getElementById('search-results').style.display = 'block';
    }

    // Add Channel
    let selectedChannels = [];

    function addChannel(channel) {
        selectedChannels.push(channel);
        updateChannelsList();
        document.getElementById('execute-channels-btn').disabled = false;
    }

    // Update Channels List
    function updateChannelsList() {
        const container = document.getElementById('channels-list');
        container.innerHTML = '';

        selectedChannels.forEach((channel, index) => {
            const item = document.createElement('div');
            item.className = 'card mb-2';
            item.innerHTML = `
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@${channel.username}</strong>
                        <br><small>${channel.title}</small>
                    </div>
                    <div>
                        <select class="form-select form-select-sm" id="action-${index}">
                            <option value="view_only">View Only</option>
                            <option value="subscribe">Subscribe</option>
                        </select>
                        <input type="number" class="form-control form-control-sm mt-1" 
                               id="read-count-${index}" value="5" min="1" max="20">
                        <button class="btn btn-sm btn-danger mt-1" onclick="removeChannel(${index})">Remove</button>
                    </div>
                </div>
            </div>
        `;
            container.appendChild(item);
        });

        document.getElementById('channel-count').textContent = selectedChannels.length;
    }

    // Remove Channel
    function removeChannel(index) {
        selectedChannels.splice(index, 1);
        updateChannelsList();

        if (selectedChannels.length === 0) {
            document.getElementById('execute-channels-btn').disabled = true;
        }
    }

    // Execute Channels
    async function executeChannels() {
        // Add channels to backend first
        for (let i = 0; i < selectedChannels.length; i++) {
            const channel = selectedChannels[i];
            const action = document.getElementById(`action-${i}`).value;
            const readCount = document.getElementById(`read-count-${i}`).value;

            await fetch(`/accounts/${accountId}/warmup/add-channel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    channel_id: channel.id,
                    username: channel.username,
                    title: channel.title,
                    action: action,
                    read_count: parseInt(readCount)
                })
            });
        }

        // Execute
        try {
            const response = await fetch(`/accounts/${accountId}/warmup/execute-channels`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                alert('‚úÖ Channels processed!');
                selectedChannels = [];
                updateChannelsList();
                loadLogs();
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (e) {
            alert('‚ùå Error: ' + e.message);
        }
    }

    // Load Activity Logs
    async function loadLogs() {
        try {
            const response = await fetch(`/accounts/${accountId}/warmup/logs`);
            const data = await response.json();

            const tbody = document.getElementById('logs-tbody');
            tbody.innerHTML = '';

            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    const row = document.createElement('tr');

                    // Status-based row class
                    let rowClass = '';
                    if (log.status === 'failed') rowClass = 'table-danger';
                    else if (log.status === 'pending') rowClass = 'table-warning';
                    row.className = rowClass;

                    // Category badge color
                    let categoryBadge = 'bg-secondary';
                    if (log.category === 'warmup') categoryBadge = 'bg-warning';
                    else if (log.category === 'system') categoryBadge = 'bg-info';
                    else if (log.category === 'campaign') categoryBadge = 'bg-primary';
                    else if (log.category === 'profile') categoryBadge = 'bg-success';

                    // Status badge
                    let statusBadge = 'bg-light text-dark';
                    let statusIcon = '';
                    if (log.status === 'success') {
                        statusBadge = 'bg-success';
                        statusIcon = '‚úì ';
                    } else if (log.status === 'failed') {
                        statusBadge = 'bg-danger';
                        statusIcon = '‚úó ';
                    } else if (log.status === 'pending') {
                        statusBadge = 'bg-warning';
                        statusIcon = '‚è≥ ';
                    }

                    row.innerHTML = `
                        <td><small>${log.timestamp}</small></td>
                        <td><span class="badge bg-secondary">${log.action_type}</span></td>
                        <td><span class="badge ${categoryBadge}">${log.category}</span></td>
                        <td><span class="badge ${statusBadge}">${statusIcon}${log.status}</span></td>
                        <td><small>${log.description || '-'}</small></td>
                    `;

                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No activity yet</td></tr>';
            }
        } catch (e) {
            console.error('Failed to load logs:', e);
            document.getElementById('logs-tbody').innerHTML =
                '<tr><td colspan="5" class="text-center text-danger">Failed to load logs</td></tr>';
        }
    }

    // Load logs on page load
    document.addEventListener('DOMContentLoaded', loadLogs);
</script>