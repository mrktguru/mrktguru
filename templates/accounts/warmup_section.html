<!-- Warmup System Section -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üî• Account Warmup</h5>
    </div>
    <div class="card-body">
        <!-- Progress Bar -->
        <div class="warmup-progress mb-3">
            <div class="progress">
                <div class="progress-bar" style="width: 0%" id="warmup-progress-bar">0%</div>
            </div>
            <small class="text-muted">Stage 1/4: Profile</small>
        </div>

        <!-- Warmup Stages Accordion -->
        <div class="accordion" id="warmupAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#stage1">
                        <span class="badge bg-secondary me-2">1</span>
                        Stage 1: Profile Setup
                    </button>
                </h2>
                <div id="stage1" class="accordion-collapse collapse show" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <!-- Manual Settings -->
                        <h6>Manual Settings</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Privacy - Phone</label>
                                <select class="form-select" id="privacy-phone">
                                    <option value="nobody">Nobody</option>
                                    <option value="contacts">My Contacts</option>
                                    <option value="everybody">Everybody</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Language</label>
                                <select class="form-select" id="language">
                                    <option value="en">English</option>
                                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label for="first-name" class="form-label small">First Name</label>
                                <input type="text" class="form-control form-control-sm" id="first-name"
                                    value="{{ account.first_name or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="last-name" class="form-label small">Last Name</label>
                                <input type="text" class="form-control form-control-sm" id="last-name"
                                    value="{{ account.last_name or '' }}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="username" class="form-label small">Username (@...)</label>
                            <input type="text" class="form-control form-control-sm" id="username"
                                value="{{ account.username or '' }}" placeholder="username">
                            <small class="text-muted small">Only changed fields will be updated on Telegram.</small>
                        </div>

                        <div class="mb-3">
                            <label for="bio" class="form-label small">Bio</label>
                            <textarea class="form-control form-control-sm" id="bio"
                                rows="2">{{ account.bio or '' }}</textarea>
                        </div>
                        <ul class="text-muted">
                            <li>Importing contacts</li>
                            <li>Viewing contact list</li>
                            <li>Saving to Saved Messages</li>
                        </ul>
                        <p class="text-muted mb-0">
                            <strong>Status:</strong> Optional - Coming soon
                        </p>
                        <div class="mb-3">
                            <label>Photo</label>
                            <input type="file" class="form-control" id="photo" accept="image/*">
                        </div>

                        <button class="btn btn-primary" onclick="executeProfile()" id="execute-profile-btn">
                            <i class="bi bi-play-fill"></i> Execute Stage 1
                        </button>

                        <!-- Progress indicator -->
                        <div id="progress-stage-1" class="mt-3" style="display:none">
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                    style="width: 0%"></div>
                            </div>
                            <div class="status-text small text-muted">Initializing Stage 1...</div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Stage 2: Contacts -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#stage2">
                        <span class="badge bg-secondary me-2">2</span>
                        Stage 2: Contacts
                    </button>
                </h2>
                <div id="stage2" class="accordion-collapse collapse" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <h6>Contact Activities</h6>
                        <div class="mb-3">
                            <label for="contact-phones">Phone Numbers (one per line)</label>
                            <textarea class="form-control" id="contact-phones" rows="3"
                                placeholder="+79123456789&#10;+79987654321"></textarea>
                            <small class="text-muted">Importing contacts helps build account trust.</small>
                        </div>

                        <ul class="text-muted small">
                            <li><i class="bi bi-check2"></i> Importing provided contacts</li>
                            <li><i class="bi bi-check2"></i> Viewing account contact list</li>
                            <li><i class="bi bi-check2"></i> Sending test message to "Saved Messages"</li>
                        </ul>

                        <button class="btn btn-primary" onclick="executeContacts()" id="execute-contacts-btn">
                            <i class="bi bi-play-fill"></i> Execute Stage 2
                        </button>

                        <!-- Progress indicator -->
                        <div id="progress-stage-2" class="mt-3" style="display:none">
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                    style="width: 0%"></div>
                            </div>
                            <div class="status-text small text-muted">Initializing Stage 2...</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Stage 3: Subscriptions -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#stage3">
                        <span class="badge bg-secondary me-2">3</span>
                        Stage 3: Subscriptions
                    </button>
                </h2>
                <div id="stage3" class="accordion-collapse collapse" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <!-- Channel Search -->
                        <h6>Search Channels</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="channel-search-query"
                                placeholder="Enter channel name or keyword">
                            <button class="btn btn-primary" onclick="searchChannels()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>

                        <!-- Search Results -->
                        <div id="search-results" style="display:none">
                            <h6>Search Results</h6>
                            <div id="results-list" class="list-group mb-3"></div>
                        </div>

                        <!-- Selected Channels -->
                        <div id="selected-channels">
                            <h6>Selected Channels (<span id="channel-count">0</span>)</h6>
                            <div id="channels-list"></div>
                        </div>

                        <button class="btn btn-success" onclick="executeChannels()" disabled id="execute-channels-btn">
                            <i class="bi bi-play-fill"></i> Execute Stage 3
                        </button>

                        <!-- Progress indicator -->
                        <div id="progress-stage-3" class="mt-3" style="display:none">
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                    style="width: 0%"></div>
                            </div>
                            <div class="status-text small text-muted">Initializing Stage 3...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stage 4: Activity -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#stage4">
                        <span class="badge bg-secondary me-2">4</span>
                        Stage 4: Activity
                    </button>
                </h2>
                <div id="stage4" class="accordion-collapse collapse" data-bs-parent="#warmupAccordion">
                    <div class="accordion-body">
                        <p class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Stage 4 (Activity & Engagement) will include:
                        </p>
                        <ul class="text-muted">
                            <li>Viewing feed and stories</li>
                            <li>Reacting to posts</li>
                            <li>Interacting with bots</li>
                            <li>Joining groups</li>
                        </ul>
                        <p class="text-muted mb-0">
                            <strong>Status:</strong> Coming soon
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Logs Section - Full Width -->
<div class="card mb-3">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0">üìã Activity Logs</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto">
            <table class="table table-sm table-hover mb-0" id="logs-table">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 130px;">Time</th>
                        <th style="width: 100px;">Action</th>
                        <th style="width: 90px;">Category</th>
                        <th style="width: 80px;">Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls -->
        <div class="card-footer d-flex justify-content-between align-items-center">
            <button class="btn btn-sm btn-outline-secondary" id="prev-page-btn" onclick="loadPrevPage()" disabled>
                <i class="bi bi-chevron-left"></i> Previous
            </button>
            <span class="small text-muted" id="page-info">Page 1</span>
            <button class="btn btn-sm btn-outline-secondary" id="next-page-btn" onclick="loadNextPage()" disabled>
                Next <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</div>


<script>
    // Warmup JavaScript Functions
    const accountId = parseInt('{{ account.id }}');
    let isExecuting = false;
    let pollTimer = null;
    let activeStage = null;
    let startTS = 0;
    let currentPage = 1;
    let paginationData = null;

    // Start polling logs while executing
    async function startPolling(stage) {
        if (pollTimer) clearInterval(pollTimer);
        isExecuting = true;
        activeStage = stage;

        // Record the TS of the latest log BEFORE starting
        try {
            const response = await fetch(`/accounts/${accountId}/warmup/logs`);
            const data = await response.json();
            if (data.logs && data.logs.length > 0) {
                startTS = data.logs[0].ts || (Date.now() / 1000);
            } else {
                startTS = Date.now() / 1000;
            }
        } catch (e) {
            console.error('Failed to get initial log TS:', e);
            startTS = Date.now() / 1000;
        }
        // Initial load
        loadLogs(stage);

        // Poll every 3 seconds
        pollTimer = setInterval(() => loadLogs(stage), 3000);

        // Show progress indicator
        const container = document.getElementById(`progress-stage-${stage}`);
        if (container) {
            container.style.display = 'block';
            container.querySelector('.progress-bar').style.width = '10%';
            container.querySelector('.status-text').textContent = 'Queuing task...';
            container.querySelector('.progress-bar').classList.add('progress-bar-animated');
            container.querySelector('.progress-bar').classList.remove('bg-danger');
            container.querySelector('.progress-bar').classList.add('bg-primary');
        }

        // Disable button
        const btn = document.querySelector(`#stage${stage} button.btn-primary, #stage${stage} button.btn-success`);
        if (btn) btn.disabled = true;
    }

    // Stop polling
    function stopPolling(stage, success = true) {
        clearInterval(pollTimer);
        pollTimer = null;
        isExecuting = false;

        const container = document.getElementById(`progress-stage-${stage}`);
        if (container) {
            container.querySelector('.progress-bar').classList.remove('progress-bar-animated');
            if (success) {
                container.querySelector('.progress-bar').style.width = '100%';
                container.querySelector('.status-text').textContent = 'Completed!';
                setTimeout(() => {
                    container.style.display = 'none';
                    // Optional: refresh page to show updated info if it was profile setup
                    if (stage === 1) location.reload();
                }, 3000);
            } else {
                container.querySelector('.progress-bar').classList.replace('bg-primary', 'bg-danger');
                container.querySelector('.progress-bar').classList.replace('bg-success', 'bg-danger');
                container.querySelector('.status-text').textContent = 'Failed';
            }
        }

        const btn = document.querySelector(`#stage${stage} button.btn-primary, #stage${stage} button.btn-success`);
        if (btn) btn.disabled = false;
    }

    // Execute Profile Setup
    async function executeProfile() {
        const data = new FormData();
        data.append('first_name', document.getElementById('first-name').value);
        data.append('last_name', document.getElementById('last-name').value);
        data.append('username', document.getElementById('username').value);
        data.append('bio', document.getElementById('bio').value);
        data.append('privacy_phone', document.getElementById('privacy-phone').value);
        data.append('language', document.getElementById('language').value);

        const photoInput = document.getElementById('photo');
        if (photoInput.files.length > 0) {
            data.append('photo', photoInput.files[0]);
        }

        if (!document.getElementById('first-name').value) {
            alert('First name is required');
            return;
        }

        startPolling(1);

        try {
            const response = await fetch(`/accounts/${accountId}/warmup/execute-profile`, {
                method: 'POST',
                // Note: When sending FormData, don't set Content-Type header manually
                body: data
            });

            const result = await response.json();

            if (!result.success) {
                stopPolling(1, false);
                alert('‚ùå Failed to start: ' + result.error);
            }
            // If success, just keep polling
        } catch (e) {
            stopPolling(1, false);
            alert('‚ùå Connection Error: ' + e.message);
        }
    }

    // Execute Contacts Setup
    async function executeContacts() {
        const phonesText = document.getElementById('contact-phones').value;
        const phones = phonesText.split('\n').map(p => p.trim()).filter(p => p.length > 0);

        startPolling(2);

        try {
            const response = await fetch(`/accounts/${accountId}/warmup/execute-contacts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phones })
            });

            const result = await response.json();

            if (!result.success) {
                stopPolling(2, false);
                alert('‚ùå Failed to start: ' + result.error);
            }
        } catch (e) {
            stopPolling(2, false);
            console.error('Contacts execution error:', e);
            alert('‚ùå Connection Error: ' + e.message);
        }
    }

    // Search Channels
    async function searchChannels() {
        const query = document.getElementById('channel-search-query').value;

        if (!query) {
            alert('Enter a search query');
            return;
        }

        try {
            const response = await fetch(`/accounts/${accountId}/warmup/search-channels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            const result = await response.json();

            if (result.success) {
                displaySearchResults(result.results);
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (e) {
            alert('‚ùå Connection Error: ' + e.message);
        }
    }

    // Display Search Results
    function displaySearchResults(results) {
        const container = document.getElementById('results-list');
        container.innerHTML = '';

        results.forEach(channel => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
            <div>
                <strong>@${channel.username}</strong>
                <br><small>${channel.title} ‚Ä¢ ${channel.participants_count} members</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick='addChannel(${JSON.stringify(channel)}, "view_only")'>Visit</button>
                <button class="btn btn-sm btn-primary" onclick='addChannel(${JSON.stringify(channel)}, "subscribe")'>Subscribe</button>
            </div>
        `;
            container.appendChild(item);
        });

        document.getElementById('search-results').style.display = 'block';
    }

    // Add Channel
    let selectedChannels = [];

    function addChannel(channel, action = 'view_only') {
        channel.initialAction = action;
        selectedChannels.push(channel);
        updateChannelsList();
        document.getElementById('execute-channels-btn').disabled = false;
    }

    // Update Channels List
    function updateChannelsList() {
        const container = document.getElementById('channels-list');
        container.innerHTML = '';

        selectedChannels.forEach((channel, index) => {
            const item = document.createElement('div');
            item.className = 'card mb-2';
            item.innerHTML = `
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@${channel.username}</strong>
                        <br><small>${channel.title}</small>
                    </div>
                    <div>
                        <select class="form-select form-select-sm" id="action-${index}">
                            <option value="view_only" ${channel.initialAction === 'view_only' ? 'selected' : ''}>Visit (View Only)</option>
                            <option value="subscribe" ${channel.initialAction === 'subscribe' ? 'selected' : ''}>Subscribe</option>
                        </select>
                        <input type="number" class="form-control form-control-sm mt-1" 
                               id="read-count-${index}" value="5" min="1" max="20">
                        <button class="btn btn-sm btn-danger mt-1" onclick="removeChannel(${index})">Remove</button>
                    </div>
                </div>
            </div>
        `;
            container.appendChild(item);
        });

        document.getElementById('channel-count').textContent = selectedChannels.length;
    }

    // Remove Channel
    function removeChannel(index) {
        selectedChannels.splice(index, 1);
        updateChannelsList();

        if (selectedChannels.length === 0) {
            document.getElementById('execute-channels-btn').disabled = true;
        }
    }

    // Execute Channels
    async function executeChannels() {
        // Add channels to backend first
        for (let i = 0; i < selectedChannels.length; i++) {
            const channel = selectedChannels[i];
            const action = document.getElementById(`action-${i}`).value;
            const readCount = document.getElementById(`read-count-${i}`).value;

            console.log(`Adding channel: ${channel.username}, action: ${action}, read_count: ${readCount}`);

            try {
                const response = await fetch(`/accounts/${accountId}/warmup/add-channel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channel_id: channel.id,
                        username: channel.username,
                        title: channel.title,
                        action: action,
                        read_count: parseInt(readCount)
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error(`Failed to add channel ${channel.username}:`, result.error);
                    alert(`Error adding channel ${channel.username}: ${result.error}`);
                    return;
                }
                console.log(`Channel ${channel.username} added successfully, ID: ${result.channel_id}`);
            } catch (error) {
                console.error(`Exception adding channel ${channel.username}:`, error);
                alert(`Failed to add channel ${channel.username}: ${error.message}`);
                return;
            }
        }

        startPolling(3);

        // Execute
        try {
            const response = await fetch(`/accounts/${accountId}/warmup/execute-channels`, {
                method: 'POST'
            });

            const result = await response.json();

            if (!result.success) {
                stopPolling(3, false);
                alert('‚ùå Failed to start: ' + result.error);
            }
        } catch (e) {
            stopPolling(3, false);
            alert('‚ùå Connection Error: ' + e.message);
        }
    }

    // Load Activity Logs with pagination
    async function loadLogs(activeStage = null, page = 1) {
        try {
            const response = await fetch(`/accounts/${accountId}/warmup/logs?page=${page}&per_page=50`);
            const data = await response.json();

            // Update pagination state
            currentPage = page;
            paginationData = data.pagination;

            const tbody = document.getElementById('logs-tbody');
            tbody.innerHTML = '';

            if (data.logs && data.logs.length > 0) {
                // Update active stage progress if polling
                if (activeStage) {
                    const stageLogs = data.logs.filter(l =>
                        l.source === 'warmup' &&
                        l.stage === activeStage &&
                        (l.ts ? l.ts >= startTS : true)
                    );
                    if (stageLogs.length > 0) {
                        const latest = stageLogs[0];
                        const container = document.getElementById(`progress-stage-${activeStage}`);
                        if (container) {
                            container.querySelector('.status-text').textContent = latest.description;

                            // Estimate % (rough based on typical step counts)
                            let progress = 10;
                            if (activeStage === 1) progress = Math.min(95, (stageLogs.length / 5) * 100);
                            if (activeStage === 2) progress = Math.min(95, (stageLogs.length / 4) * 100);
                            if (activeStage === 3) progress = Math.min(95, (stageLogs.length / (selectedChannels.length * 3 || 1)) * 100);

                            progress = Math.max(10, progress);
                            container.querySelector('.progress-bar').style.width = `${progress}%`;

                            const completeActions = ['complete', 'set_photo', 'send_saved_message', 'read_posts_success', 'visit_success'];
                            if (latest.status === 'success' && completeActions.includes(latest.action_type)) {
                                stopPolling(activeStage, true);
                            } else if (latest.status === 'error' || latest.status === 'failed') {
                                stopPolling(activeStage, false);
                            }
                        }
                    }
                }

                data.logs.forEach(log => {
                    const row = document.createElement('tr');

                    // Status-based row class
                    let rowClass = '';
                    if (log.status === 'failed' || log.status === 'error') rowClass = 'table-danger';
                    else if (log.status === 'pending') rowClass = 'table-warning';
                    row.className = rowClass;

                    // Category badge color
                    let categoryBadge = 'bg-secondary';
                    if (log.category === 'warmup') categoryBadge = 'bg-warning';
                    else if (log.category === 'system') categoryBadge = 'bg-info';
                    else if (log.category === 'campaign') categoryBadge = 'bg-primary';
                    else if (log.category === 'profile') categoryBadge = 'bg-success';

                    // Status badge
                    let statusBadge = 'bg-light text-dark';
                    let statusIcon = '';
                    if (log.status === 'success') {
                        statusBadge = 'bg-success';
                        statusIcon = '‚úì ';
                    } else if (log.status === 'failed' || log.status === 'error') {
                        statusBadge = 'bg-danger';
                        statusIcon = '‚úó ';
                    } else if (log.status === 'pending' || log.status === 'info') {
                        statusBadge = 'bg-info';
                        statusIcon = '‚Ñπ ';
                        if (log.status === 'pending') {
                            statusBadge = 'bg-warning';
                            statusIcon = '‚è≥ ';
                        }
                    }

                    row.innerHTML = `
                        <td><small>${log.timestamp}</small></td>
                        <td><span class="badge bg-secondary">${log.action_type || 'warmup'}</span></td>
                        <td><span class="badge ${categoryBadge}">${log.category}</span></td>
                        <td><span class="badge ${statusBadge}">${statusIcon}${log.status}</span></td>
                        <td><small>${log.description || '-'}</small></td>
                    `;

                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No activity yet</td></tr>';
            }

            // Update pagination controls
            updatePaginationControls();
        } catch (e) {
            console.error('Failed to load logs:', e);
            if (!isExecuting) {
                document.getElementById('logs-tbody').innerHTML =
                    '<tr><td colspan="5" class="text-center text-danger">Failed to load logs</td></tr>';
            }
        }
    }

    // Update pagination button states
    function updatePaginationControls() {
        const prevBtn = document.getElementById('prev-page-btn');
        const nextBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');

        if (paginationData) {
            prevBtn.disabled = !paginationData.has_prev;
            nextBtn.disabled = !paginationData.has_next;
            pageInfo.textContent = `Page ${paginationData.page} of ${paginationData.total_pages} (${paginationData.total} logs)`;
        }
    }

    // Pagination helpers
    function loadPrevPage() {
        if (currentPage > 1) {
            loadLogs(null, currentPage - 1);
        }
    }

    function loadNextPage() {
        if (paginationData && paginationData.has_next) {
            loadLogs(null, currentPage + 1);
        }
    }
</script>

    // Load logs on page load
    document.addEventListener('DOMContentLoaded', () => loadLogs());
</script>
